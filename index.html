<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²æ•™å®¤èªè©é€ å¥ç¿»ç¿»ç‰Œv2.5.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        #cardsGrid {
            gap: 2rem 1.5rem;
        }
        .card-container {
            width: 100%;
            height: 280px;
        }
        .perspective {
            perspective: 1500px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transform-style: preserve-3d;
        }
        .is-flipped {
            transform: rotateY(180deg);
        }
        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .flip-card-back {
            transform: rotateY(180deg);
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .story-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem;
        }
        .word-item {
            display: flex; align-items: center; justify-content: space-between;
            background-color: white; padding: 8px 12px; border-radius: 6px;
            margin-bottom: 8px; border: 1px solid #e5e7eb;
        }
        .delete-btn {
            background: none; border: none; cursor: pointer; font-size: 1.2rem;
            color: #ef4444; transition: color 0.2s; padding-left: 0.5rem;
        }
        .clear-all-btn {
            font-size: 0.8rem; font-weight: bold; color: #64748b;
            cursor: pointer; transition: color 0.2s;
        }
        .clear-all-btn:hover { color: #dc2626; }
        .batch-textarea {
            width: 100%; min-height: 100px; padding: 8px; border: 1px solid #cbd5e1;
            border-radius: 6px; margin-top: 8px; font-size: 0.9rem;
        }
        .category-title-input {
            width: 100%;
            font-weight: bold;
            color: #334155;
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid transparent;
            background-color: transparent;
            transition: all 0.2s;
        }
        .category-title-input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: white;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #aiModal .modal-content {
             max-width: 600px;
             text-align: left;
        }
        #analysisModal .modal-content {
            max-width: 1000px;
            text-align: left;
        }
        .form-label {
            display: block; font-weight: bold; color: #475569; margin-bottom: 0.5rem;
        }
        .form-select, .form-textarea {
            width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;
        }
        .form-checkbox-group {
             max-height: 250px;
             overflow-y: auto; background-color: #f8fafc;
             padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;
             display: grid;
             grid-template-columns: repeat(3, 1fr);
             gap: 0.5rem 1rem;
        }
        .form-checkbox-item { display: flex; align-items: center; }
        .form-checkbox { margin-right: 0.5rem; width: 1.25rem; height: 1.25rem; accent-color: #3b82f6; }
        
        .toggle-switch {
            position: relative; display: inline-block; width: 50px; height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #2563eb; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        
        #aiSentenceOutput .result-item {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s, height 0.3s ease-in-out;
            min-height: 150px; /* å¢åŠ æœ€å°é«˜åº¦ä»¥å®¹ç´è¼‰å…¥å‹•ç•« */
        }
        #aiSentenceOutput .result-item-content {
            cursor: pointer;
        }
        #aiSentenceOutput .result-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .sentence-pattern {
            display: inline-block;
            background-color: #fef08a;
            color: #1e293b;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }
        .sentence-analysis-prompt {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2563eb; /* blue-600 */
            text-align: right;
            padding-left: 1rem;
            line-height: 1.4;
        }
        #customModal .sentence-analysis-prompt {
            font-size: 1.1rem; /* æ”¾å¤§ Modal ä¸­çš„æç¤ºæ–‡å­— */
        }
        
        #aiSentenceOutput .sentence-text {
            font-size: 1.75rem;
            font-weight: 500;
            color: #1e293b;
            line-height: 1.6;
        }
        .highlight-word {
            background-color: #fef9c3;
            color: #713f12;
            padding: 0 2px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .sentence-actions {
            display: flex;
            gap: 0.75rem; /* 12px */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb; /* slate-200 */
        }
        .sentence-action-btn {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
            border-radius: 9999px; /* rounded-full */
            width: 2.75rem; /* w-11 */
            height: 2.75rem; /* h-11 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* text-xl */
            transition: all 0.2s;
            border: 1px solid #e2e8f0; /* slate-200 */
            cursor: pointer;
        }
        .sentence-action-btn:hover {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
            transform: scale(1.05);
        }
        
        .ai-gen-btn {
            background: linear-gradient(135deg, #60a5fa, #818cf8);
            color: white; border: none; border-radius: 50%;
            width: 28px; height: 28px; font-size: 14px;
            cursor: pointer; transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .ai-gen-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .analysis-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        #scrambleModal .modal-content {
            max-width: 1000px;
            text-align: left;
            position: relative; 
            transform: translate(0px, 0px) scale(0.95);
        }
        #scrambleModal .modal-content h3 {
            cursor: move;
            user-select: none;
            padding-bottom: 1rem; 
        }

        .scramble-zone {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            transition: all 0.2s;
        }
        #scrambleTarget {
            background-color: #f8fafc; /* slate-50 */
            border: 2px dashed #cbd5e1; /* slate-300 */
        }
        #scrambleSource {
            background-color: #f1f5f9; /* slate-100 */
            border: 1px solid #e2e8f0; /* slate-200 */
            margin-top: 1rem;
            min-height: 120px;
        }
        .scramble-block {
            position: relative; 
            padding: 0.75rem 1.25rem;
            background-color: white;
            color: #1e293b; /* slate-800 */
            font-size: 1.25rem;
            font-weight: 500;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            cursor: grab;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            user-select: none;
        }
        .scramble-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .scramble-block.dragging {
            opacity: 0.5;
            background-color: #e0f2fe; /* sky-100 */
            box-shadow: none;
        }
        #scrambleTarget.drag-over {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        #scrambleTarget.is-correct {
            border-color: #22c55e; /* green-500 */
            border-style: solid;
        }
        #scrambleTarget.is-incorrect {
            border-color: #ef4444; /* red-500 */
            border-style: solid;
        }
        #scrambleHint {
            background-color: #fffbeb; /* yellow-50 */
            border: 1px solid #fef3c7; /* yellow-200 */
            color: #a16207; /* yellow-700 */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: bold;
        }

        .scramble-remove-btn {
            display: none; 
            position: absolute;
            top: -10px;
            right: -10px;
            width: 26px;
            height: 26px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px; 
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .scramble-remove-btn:hover {
            background-color: #dc2626; /* red-600 */
            transform: scale(1.1);
        }
        #scrambleTarget .scramble-block .scramble-remove-btn {
            display: flex;
        }
        #scrambleTarget .scramble-block {
            padding-right: 1.5rem;
        }
        
        .scramble-block {
            border-bottom-width: 4px;
        }
        .scramble-block.pos-n { /* åè© */
            background-color: #e0f2fe; /* sky-100 */
            color: #0c4a6e; /* sky-800 */
            border-color: #7dd3fc; /* sky-300 */
        }
        .scramble-block.pos-v { /* å‹•è© */
            background-color: #dcfce7; /* green-100 */
            color: #166534; /* green-800 */
            border-color: #86efac; /* green-300 */
        }
        .scramble-block.pos-adj { /* å½¢å®¹è© */
            background-color: #fef3c7; /* yellow-100 */
            color: #854d0e; /* yellow-800 */
            border-color: #fde047; /* yellow-400 */
        }
        .scramble-block.pos-adv { /* å‰¯è© */
            background-color: #f3e8ff; /* purple-100 */
            color: #581c87; /* purple-800 */
            border-color: #c084fc; /* purple-400 */
        }
        .scramble-block.pos-prep { /* ä»‹è© */
            background-color: #ffe4e6; /* red-100 */
            color: #9f1239; /* red-800 */
            border-color: #fda4af; /* red-300 */
        }
        .scramble-block.pos-conj { /* é€£è© */
            background-color: #ffedd5; /* orange-100 */
            color: #9a3412; /* orange-800 */
            border-color: #fdba74; /* orange-300 */
        }
        .scramble-block.pos-part { /* åŠ©è© */
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            border-color: #a5b4fc; /* indigo-300 */
        }
        .scramble-block.pos-pron { /* ä»£åè© */
            background-color: #f0fdfa; /* teal-50 */
            color: #134e4a; /* teal-800 */
            border-color: #99f6e4; /* teal-200 */
        }
        .scramble-block.pos-ono { /* ç‹€è²è© */
            background-color: #fef9c3; /* yellow-50 */
            color: #a16207; /* yellow-700 */
            border-color: #facc15; /* yellow-500 */
        }
        .scramble-block.pos-punc { /* æ¨™é» */
            background-color: #f1f5f9; /* slate-100 */
            color: #334155; /* slate-700 */
            border-color: #cbd5e1; /* slate-300 */
        }
        .scramble-block.pos-default { /* é è¨­/å…¶ä»– */
            background-color: #fafafa; /* gray-50 */
            color: #111827; /* gray-900 */
            border-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="bg-sky-50 min-h-screen flex items-center justify-center p-4">

    <div class="container mx-auto max-w-7xl">
        <header class="text-center mb-8">
          <h1 id="headerTitle" class="text-4xl md:text-5xl font-bold text-sky-800">ğŸ¯ é›²æ•™å®¤é€ å¥ç¿»ç¿»ç‰Œ v2.5.4</h1>
            <p id="headerSubtitle" class="text-lg text-slate-600 mt-2">é»æ“Šå¡ç‰‡ç¿»é¢ï¼Œçµ„åˆç„¡é™å‰µæ„ï¼</p>
        </header>

        <main>
            <div id="settingsPage" class="page active">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-slate-700 mb-6">âš™ï¸ ç¿»ç¿»ç‰Œè¨­å®š</h2>
                    
                    <div class="mb-6 p-4 border border-blue-200 bg-blue-50 rounded-lg">
                        <label for="apiKeyInput" class="block text-sm font-medium text-slate-700 mb-2">ğŸ”‘ Google AI API é‡‘é‘°</label>
                        <input type="password" id="apiKeyInput" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-slate-500 mt-2">
                            AI åŠŸèƒ½éœ€è¦æ‚¨è‡ªå·±çš„ Google AI API é‡‘é‘°ã€‚
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">é»æ­¤å…è²»å–å¾—é‡‘é‘°</a>ã€‚é‡‘é‘°æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå¤–æ´©ã€‚
                        </p>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8 border-b pb-6">
                        <button class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105" onclick="startGame()">ğŸš€ é–‹å§‹</button>
                        <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-full shadow-md transition-transform transform hover:scale-105" onclick="openAnalysisModal()">ğŸ”¬ åˆ†æå¥å‹/èªè©</button>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-md transition-transform transform hover:scale-105" onclick="document.getElementById('importFile').click()">ğŸ“ åŒ¯å…¥è¨­å®š</button>
                        <input type="file" id="importFile" accept=".json" class="hidden" onchange="importSettings(event)">
                        <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-full shadow-md transition-transform transform hover:scale-105" onclick="exportSettings()">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-full shadow-md transition-transform transform hover:scale-105" onclick="handleResetToDefault()">ğŸ”„ é‡ç½®é è¨­</button>
                    </div>
                    <div id="editSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>

            <div id="gamePage" class="page">
                <div id="game-controls" class="flex flex-wrap justify-center gap-4 mb-8">
                    <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-full shadow-md hover:shadow-lg transition-transform transform hover:scale-105" onclick="backToSettings()">â¬…ï¸ è¿”å›è¨­å®š</button>
                    <button class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-full shadow-md hover:shadow-lg transition-transform transform hover:scale-105" onclick="flipAllCards()">ğŸ² å…¨éƒ¨ç¿»é–‹</button>
                    <button class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-5 rounded-full shadow-md hover:shadow-lg transition-transform transform hover:scale-105" onclick="resetAllCards()">ğŸ”„ å…¨éƒ¨é‡ç½®</button>
                    </div>
                <div id="cardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                    </div>
                <div id="aiSentenceOutput" class="mt-8">
                    </div>
            </div>
        </main>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4 cursor-pointer" onclick="closeImageModal(event)">
        <div class="relative bg-white p-2 rounded-lg max-w-4xl max-h-[90vh]" onclick="event.stopPropagation()">
            <img id="modalImage" src="" class="object-contain max-w-full max-h-[85vh]" alt="æ”¾å¤§çš„æ•…äº‹å¡åœ–ç‰‡">
        </div>
        <button onclick="closeImageModal(event)" class="absolute top-6 right-6 bg-white rounded-full h-10 w-10 text-2xl font-bold flex items-center justify-center text-black z-20 leading-none shadow-lg hover:bg-gray-200 transition">&times;</button>
    </div>

    <div id="customModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50" style="opacity: 0;"></div>
        <div class="modal-content relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6 text-center" style="transform: translate(0px, 0px) scale(0.95); opacity: 0;">
            <h3 id="modalTitle" class="text-xl font-bold text-slate-800 mb-4">æç¤ºè¨Šæ¯</h3>
            <div id="modalMessage" class="text-slate-600 mb-6"></div>
            <div id="modalActions" class="flex justify-center gap-4"></div>
        </div>
    </div>
    
    <div id="aiModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50" onclick="closeAiModal()"></div>
        <div class="modal-content relative bg-white rounded-2xl shadow-xl w-full p-6 space-y-4 overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-800">ğŸ¤– AI é€ å¥æ”¹å¯«</h3>
                <button onclick="closeAiModal()" class="text-3xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div>
                <label class="form-label">1. å‹¾é¸è©èª (å·²éš¨æ©Ÿé é¸1å€‹ï¼Œç”¨æ–¼å¥å‹/é€ å¥)ï¼š</label>
                <div id="aiWordSelection" class="form-checkbox-group"></div>
            </div>
            <div>
                <label class="form-label">2. æŒ‡å®šå¥å‹ (é¸å¡«)ï¼š</label>
                <select id="aiPatternSelect" class="form-select mb-2">
                    <option value="">-- ç”±AIè‡ªç”±ç™¼æ® --</option>
                </select>
                <textarea id="aiPatternInput" class="form-textarea" rows="2" placeholder="æˆ–åœ¨æ­¤æ‰‹å‹•è¼¸å…¥çŸ­èªã€å¥å‹ã€é—œéµè©..."></textarea>
            </div>
            <div class="mt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">å¹´ç´šç¨‹åº¦ï¼š</label>
                        <div class="flex flex-wrap gap-2" id="gradeLevelSelection">
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="grade" value="low"><span>ğŸ§’ ä½</span></label>
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="grade" value="middle"><span>ğŸ‘¦ ä¸­</span></label>
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="grade" value="high" checked><span>ğŸ‘¨ é«˜</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">å¥å­å­—æ•¸ï¼š</label>
                        <div class="flex flex-wrap gap-2" id="wordCountSelection">
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="wordCount" value="unlimited" checked><span>â™¾ï¸ ä¸é™</span></label>
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="wordCount" value="15-30"><span>ğŸ“ 15-30</span></label>
                            <label class="flex items-center space-x-2 p-2 border rounded-full cursor-pointer"><input type="radio" name="wordCount" value="30+"><span>ğŸ“œ 30+</span></label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="form-label">é¸æ“‡é¢¨æ ¼ï¼š</label>
                        <select id="aiStyleSelect" class="form-select">
                            <option>æ¨™æº–é¢¨æ ¼</option> <option>ç”Ÿå‹•æœ‰è¶£</option> <option>å„ªç¾è©©æ„</option>
                            <option>æ‚²å‚·æ†‚é¬±</option> <option>å¹½é»˜æ´»æ½‘</option> <option>æç¬‘å‰µæ„</option>
                            <option>çµåˆå­¸ç”Ÿç”Ÿæ´»</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">å…è¨±å‰µæ„è¯æƒ³ï¼Ÿ</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aiCreativeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <button id="aiGenerateBtn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 mt-4" onclick="handleGenerateSentences()">ğŸš€ ç”¢ç”Ÿå¥å­</button>
        </div>
    </div>

    <div id="analysisModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50" onclick="closeAnalysisModal()"></div>
        <div class="modal-content relative bg-white rounded-2xl shadow-xl w-full p-6 space-y-4 overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-800">ğŸ”¬ AI åˆ†æå¥å‹/èªè©</h3>
                <button onclick="closeAnalysisModal()" class="text-3xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                <div class="analysis-section h-full">
                    <div class="flex justify-between items-center">
                        <label class="form-label">1. æä¾›è³‡æ–™ä¾†æº</label>
                        <span class="clear-all-btn" onclick="clearAnalysisData()">ğŸ—‘ï¸ æ¸…é™¤æš«å­˜</span>
                    </div>
                    <div class="flex gap-4 my-2">
                        <label class="flex items-center"><input type="radio" name="analysisType" value="words" class="mr-2 accent-blue-500" checked><span>åˆ†æèªè©</span></label>
                        <label class="flex items-center"><input type="radio" name="analysisType" value="patterns" class="mr-2 accent-blue-500"><span>åˆ†æå¥å‹</span></label>
                    </div>
                    <textarea id="analysisSourceText" class="form-textarea flex-grow" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå‚™èª²è³‡æ–™æ–‡å­—..."></textarea>
                    <div class="text-center my-2 text-slate-500">æˆ–</div>
                    <button class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('analysisSourceFile').click()">ğŸ“„ å¾ç´”æ–‡å­—æª”ä¸Šå‚³</button>
                    <input type="file" id="analysisSourceFile" class="hidden" accept=".txt,.md">
                </div>
                <div class="analysis-section h-full">
                    <label class="form-label">2. åˆ†æçµæœ</label>
                    <textarea id="analysisResultText" class="form-textarea flex-grow" rows="10" placeholder="AI åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                    <div class="flex gap-2 mt-4">
                        <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" onclick="copyAnalysisResults()">ğŸ“‹ è¤‡è£½</button>
                        <select id="analysisImportSelect" class="form-select flex-grow"></select>
                        <button id="analysisImportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400" onclick="handleImportAnalysis()" disabled>ğŸ“¥ å°å…¥</button>
                    </div>
                </div>
            </div>
            <button id="analysisRunBtn" class="w-full bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all mt-4" onclick="handleRunAnalysis()">ğŸ¤– é–‹å§‹åˆ†æ</button>
        </div>
    </div>
    
    <div id="scrambleModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50" onclick="closeScrambleGame()"></div>
        <div class="modal-content relative bg-white rounded-2xl shadow-xl w-full p-6 space-y-4 overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-800 flex-grow">ğŸ§© å¥å­é‡çµ„éŠæˆ²</h3>
                <button onclick="closeScrambleGame()" class="text-3xl font-bold text-gray-500 hover:text-gray-800 flex-shrink-0">&times;</button>
            </div>
            
            <div>
                <label class="form-label">1. ä½œç­”å€ (è«‹å°‡ä¸‹æ–¹æ–¹å¡Šæ‹–æ›³è‡³æ­¤è™•æ’åˆ—)</label>
                <div id="scrambleTarget" class="scramble-zone">
                    </div>
            </div>
            
            <div>
                <label class="form-label">2. èªæ–™åº« (å¯æ‹–æ›³çš„æ–¹å¡Š)</label>
                <div id="scrambleSource" class="scramble-zone">
                    </div>
            </div>
            
            <div id="scrambleHint" class="hidden"></div>
            
            <div class="flex flex-wrap justify-center gap-4 pt-4 border-t">
                <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-full" onclick="checkScrambleAnswer()">âœ”ï¸ æª¢æŸ¥ç­”æ¡ˆ</button>
                <button class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-5 rounded-full" onclick="resetScrambleGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
                <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-5 rounded-full" onclick="toggleScrambleHint()">ğŸ’¡ æŸ¥çœ‹æç¤º</button>
                <button class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-full" onclick="closeScrambleGame()">ğŸšª é—œé–‰éŠæˆ²</button>
            </div>
        </div>
    </div>


    <audio id="flipSound" src="https://taira-komori.net/sound_os2/game01/button01a.mp3" preload="auto"></audio>

<script>
    // v2.5.4: ä¿®æ­£ v2.5.3 ä¸­ getPosClass å‡½å¼çš„ SyntaxError
    const defaultCards = [
        { id: 'person', title: 'ğŸ“Œ ä»€éº¼äººç‰©', color: 'bg-rose-400', backColor: 'bg-rose-100', content: ['å¤§é›„', 'èƒ–è™', 'éœé¦™', 'å“†å•¦Aå¤¢', 'å°å¤«', 'å“¥å“¥', 'æ˜¥å¤©', 'çš‡å¸', 'å“¡å·¥', 'çˆ¸çˆ¸', 'æ ¡é•·', 'ä¸»ä»»', 'è€å¸«', 'åª½åª½', 'å­¸ç”Ÿ', 'æœ‹å‹', 'å¸æ©Ÿ', 'éƒµå·®', 'ç‹—ç‹—', 'è²“å’ª', 'å¤ªé™½', 'æœˆäº®', 'é¢¨', 'é›¨', 'é›»é¢¨æ‰‡', 'ç«è»Š', 'é£›æ©Ÿ', 'æ¤…å­', 'æ‰‹æ©Ÿ', 'æ›¸æœ¬'], type: 'text' },
        { id: 'time', title: 'ğŸ•’ ä»€éº¼æ™‚é–“', color: 'bg-amber-400', backColor: 'bg-amber-100', content: ['æ—©ä¸Š', 'ä¸­åˆ', 'æ™šä¸Š', 'æ¸…æ™¨', 'åŠå¤œ', 'æ”¾å­¸å¾Œ', 'åƒé£½å¾Œ', 'èµ·åºŠå¾Œ', 'ç¡è¦ºå‰', 'ä¸‹èª²æ™‚', 'ä¸Šèª²æ™‚', 'å‡æ—¥', 'é€±æœ«', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäº”', 'å¯’å‡', 'æš‘å‡', 'æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©', 'ä»Šå¤©', 'æ˜¨å¤©', 'æ˜å¤©', 'å‰›æ‰', 'ç­‰ä¸€ä¸‹', 'æ¯å¤©', 'å¹³å¸¸', 'æ—©è‡ªç¿’', 'é‹å‹•æ™‚é–“'], type: 'text' },
        { id: 'place', title: 'ğŸ“ ä»€éº¼åœ°é»', color: 'bg-lime-500', backColor: 'bg-lime-100', content: ['å…¬åœ’', 'æ“å ´', 'é¦¬è·¯ä¸Š', 'æ•™å®¤è£¡', 'åœ–æ›¸é¤¨', 'å®¶è£¡', 'å­¸æ ¡', 'ä¾¿åˆ©å•†åº—', 'è¶…å¸‚', 'é¤å»³', 'å»šæˆ¿', 'æµ´å®¤', 'æ“å ´é‚Š', 'èµ°å»Šä¸Š', 'é†«é™¢', 'è»Šç«™', 'é›»å½±é™¢', 'ç™¾è²¨å…¬å¸', 'å±±ä¸Š', 'æµ·é‚Š', 'æ²³é‚Š', 'å‹•ç‰©åœ’', 'åšç‰©é¤¨', 'æ•™å ‚', 'æ ¡é–€å£', 'æ•™å‹™è™•', 'è¾¦å…¬å®¤', 'éŸ³æ¨‚æ•™å®¤', 'ç¾è¡“æ•™å®¤', 'é›»è…¦æ•™å®¤'], type: 'text' },
        { id: 'action', title: 'ğŸƒ ä»€éº¼å‹•ä½œ', color: 'bg-cyan-400', backColor: 'bg-cyan-100', content: ['èˆ‰æ‰‹', 'åèˆŒé ­', 'æ‹¿', 'è·‘', 'è·³', 'ç¬‘', 'å“­', 'èªªè©±', 'æ‰“é–‹', 'é—œé–€', 'åƒ', 'å–', 'å¯«å­—', 'ç•«ç•«', 'å”±æ­Œ', 'æ‰“æƒ', 'ç¡è¦º', 'æ´—æ‰‹', 'åˆ·ç‰™', 'é–±è®€', 'èµ°è·¯', 'æ‰“çƒ', 'ä¸Ÿçƒ', 'è¸¢çƒ', 'ç©è€', 'æ¬æ±è¥¿', 'æ’éšŠ', 'é»é ­', 'æ–é ­', 'ä¼¸æ‡¶è…°'], type: 'text' },
        { id: 'event', title: 'ğŸ“– ä»€éº¼äº‹æƒ…', color: 'bg-violet-400', backColor: 'bg-violet-100', content: ['æ‰®é¬¼è‡‰', 'çœ‹æ›¸', 'è·‘æ­¥', 'é‡é¤', 'å¯«åŠŸèª²', 'æ‰“æƒæ•™å®¤', 'åšå¯¦é©—', 'åƒåŠ æ¯”è³½', 'å¹«å¿™åšå®¶äº‹', 'ç©æ¡ŒéŠ', 'é–‹æœƒ', 'èˆ‰è¾¦æ´»å‹•', 'ç·´ç¿’é‹¼ç´', 'ç•«ç•«', 'è½æ•…äº‹', 'æ’éšŠè²·æ±è¥¿', 'åƒè§€åšç‰©é¤¨', 'è€ƒè©¦', 'åƒåŠ æ—©è‡ªç¿’', 'ç¨®èŠ±', 'æ¾†æ°´', 'å”±æ­Œè¡¨æ¼”', 'åšé»å¿ƒ', 'éœ²ç‡Ÿ', 'åˆä¼‘', 'çœ‹é›»å½±', 'è²·æ–‡å…·', 'é¨è…³è¸è»Š', 'åšå‹ä½œ', 'ä¸Šé«”è‚²èª²'], type: 'text' },
        { id: 'story', title: 'ğŸ–¼ï¸ æ•…äº‹å¡', color: 'bg-slate-500', backColor: 'bg-slate-200', content: ['https://drive.google.com/thumbnail?sz=w640-h480&id=1dvhq1pscpIJ_fa3E1FM-TEsDiaCGdPDS', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1JyQmlgm2Q2aTy9v5IqaKiqnKrO9ZhzLL', 'https://drive.google.com/thumbnail?sz=w640-h480&id=158-D8boZBhyjCpG-5mB8LlPTbwowP9aI', 'https://drive.google.com/thumbnail?sz=w640-h480&id=16Eg2us4EyhBJkMzkZxmg3u-gf_ctzIS6', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1ZeOc41lClAwaq-9wqFo1o7zQl3o7OJAc', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1w5E17GWnI0tsgHWKM5OUAr7jCKpweU6K', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1EaNhjtbsy0D4SjuuimW6otN2yz5xReS9', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1LDthe2VxEMhGEiqLni_MeQlGdZPbJu_l', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1AsOm5YUKMNLvuU-P5pr1SDZKicBj195l', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1v2ADBteUtvqrdtwQ3_Ywxt0sXia56Ik9', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1QnCwCIBfeJB16pO5ObseonXJ-zwxPgir', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1IWU2-G4L3dTB8x0z9L9ZYhChNrVZW8RG', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1_HBCm2uGrVEqRKxgJxGwevVGhdSfCNVn', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1lM-eCzJKpBflND0JLFzUblXfVfcfuCd8', 'https://drive.google.com/thumbnail?sz=w640-h480&id=14KSvym3_7L4ojcajZ8axa26eD3KUJMnf', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1GBgfQJ0L5w6bkdvGunUj_Vp1_oajD85S', 'https://drive.google.com/thumbnail?sz=w640-h480&id=17mWFv08uM2kTSOEp8R8SkZBZImK-yiVC', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1z9IvfUJr7Wtm9qVzVt0f0PebB3tmU8q1', 'https://drive.google.com/thumbnail?sz=w640-h480&id=1l9EhAq7hl2a_x1_mMBZT961dB6FguILC', 'https://drive.google.com/thumbnail?sz=w640-h480&id=19BSCVubv3klb_q3hfBltXRurIXWCjHT8'], type: 'image' },
        { id: 'patterns', title: 'âœï¸ å¸¸ç”¨å¥å‹', color: 'bg-emerald-500', backColor: 'bg-emerald-100', content: ['...é›–ç„¶...ï¼Œä½†æ˜¯...', 'å› ç‚º...ï¼Œæ‰€ä»¥...', 'ä¸ä½†...ï¼Œè€Œä¸”...', 'åªè¦...ï¼Œå°±...', 'èˆ‡å…¶...ï¼Œä¸å¦‚...', 'å³ä½¿...ï¼Œä¹Ÿ...', '...ä¸€é‚Š...ï¼Œä¸€é‚Š...', '...æ–¼æ˜¯...', 'ä¸è«–...ï¼Œéƒ½...'], type: 'pattern' }
    ];
    
    let cardsData = [];
    let availableWords = [];
    const flipSound = document.getElementById('flipSound');
    let speechSynth;
    let currentUtterance = null;
    let lastGenerationParams = null; // v2.5.3: å„²å­˜ä¸Šæ¬¡çš„ AI ç”Ÿæˆè¨­å®š

    const customModal = document.getElementById('customModal');
    const modalContent = customModal.querySelector('.modal-content');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalActions = document.getElementById('modalActions');
    const analysisModal = document.getElementById('analysisModal');
    
    const scrambleModal = document.getElementById('scrambleModal');
    let currentScrambleSentence = '';
    let currentScramblePattern = '';
    let currentScrambleBlocksJSON = '[]'; 
    let currentScramblePosTagsJSON = '[]';

    // --- è³‡æ–™å­˜å– ---
    function saveDataToLocal() {
        try {
            localStorage.setItem('sentenceFlipCardData_v2_0', JSON.stringify(cardsData));
        } catch (e) { console.error("ç„¡æ³•å„²å­˜è³‡æ–™åˆ° LocalStorage:", e); }
    }

    function loadDataFromLocal() {
        try {
            const localData = localStorage.getItem('sentenceFlipCardData_v2_0');
            cardsData = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultCards));
        } catch (e) {
            console.error("ç„¡æ³•å¾ LocalStorage è®€å–è³‡æ–™ï¼Œå°‡ä½¿ç”¨é è¨­å€¼:", e);
            cardsData = JSON.parse(JSON.stringify(defaultCards));
        }
    }

    function saveAnalysisDataToLocal() {
        try {
            const sourceText = document.getElementById('analysisSourceText').value;
            localStorage.setItem('analysisSourceData_v2_0', sourceText);
        } catch (e) { console.error("ç„¡æ³•å„²å­˜åˆ†æè³‡æ–™åˆ° LocalStorage:", e); }
    }

    function loadAnalysisDataFromLocal() {
        try {
            document.getElementById('analysisSourceText').value = localStorage.getItem('analysisSourceData_v2_0') || '';
        } catch (e) { console.error("ç„¡æ³•è®€å–åˆ†æè³‡æ–™:", e); }
    }

    function clearAnalysisData() {
        localStorage.removeItem('analysisSourceData_v2_0');
        document.getElementById('analysisSourceText').value = '';
        document.getElementById('analysisResultText').value = '';
        showAlert('å·²æ¸…é™¤æš«å­˜çš„åˆ†æè³‡æ–™ã€‚');
    }

    // --- Modal é¡¯ç¤º/éš±è— ---
    function showModal(modalElement) {
        modalElement.classList.remove('hidden');
        modalElement.classList.add('flex');
        const backdrop = modalElement.querySelector('.modal-backdrop');
        const content = modalElement.querySelector('.modal-content');
        setTimeout(() => {
            if(backdrop) backdrop.style.opacity = '1';
            if(content) {
                if(!content.dataset.posX) content.dataset.posX = 0;
                if(!content.dataset.posY) content.dataset.posY = 0;
                content.style.transform = `translate(${content.dataset.posX}px, ${content.dataset.posY}px) scale(1)`;
                content.style.opacity = '1';
            }
        }, 10);
    }

    function hideModal(modalElement) {
        const backdrop = modalElement.querySelector('.modal-backdrop');
        const content = modalElement.querySelector('.modal-content');
        if(backdrop) backdrop.style.opacity = '0';
        if(content) {
            const currentX = content.dataset.posX || 0;
            const currentY = content.dataset.posY || 0;
            content.style.transform = `translate(${currentX}px, ${currentY}px) scale(0.95)`;
            content.style.opacity = '0';
        }
        setTimeout(() => {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
            
            if (modalElement.id === 'customModal') {
                modalElement.style.zIndex = '60';
            }

            if(content && !content.closest('#analysisModal') && !content.closest('#scrambleModal')) {
                content.classList.remove('max-w-2xl', 'max-w-4xl');
                content.classList.add('max-w-md');
            }
        }, 300);
    }
    
    function showAlert(message, title = 'âœ… æ“ä½œæˆåŠŸ') {
        const scrambleModal = document.getElementById('scrambleModal');
        if (!scrambleModal.classList.contains('hidden')) {
            customModal.style.zIndex = '80'; 
        } else {
            customModal.style.zIndex = '60'; 
        }

        modalTitle.textContent = title;
        modalMessage.innerHTML = `<p class="text-slate-600">${message}</p>`;
        modalActions.innerHTML = `<button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full" onclick="hideModal(customModal)">ç¢ºèª</button>`;
        modalContent.classList.remove('max-w-2xl', 'max-w-4xl');
        modalContent.classList.add('max-w-md');
        showModal(customModal);
    }

    function showConfirm(message, onConfirm, title = 'â“ è«‹ç¢ºèª') {
        const scrambleModal = document.getElementById('scrambleModal');
        if (!scrambleModal.classList.contains('hidden')) {
            customModal.style.zIndex = '80';
        } else {
            customModal.style.zIndex = '60';
        }

        modalTitle.textContent = title;
        modalMessage.innerHTML = `<p class="text-slate-600">${message}</p>`;
        modalActions.innerHTML = `
            <button id="confirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">ç¢ºå®š</button>
            <button class="bg-gray-300 hover:bg-gray-400 text-slate-800 font-bold py-2 px-6 rounded-full" onclick="hideModal(customModal)">å–æ¶ˆ</button>
        `;
        document.getElementById('confirmBtn').onclick = () => {
            hideModal(customModal);
            onConfirm();
        };
        modalContent.classList.remove('max-w-2xl', 'max-w-4xl');
        modalContent.classList.add('max-w-md');
        showModal(customModal);
    }
    
    // --- è¨­å®šé é¢ ---
    function renderEditSection() {
        const editSection = document.getElementById('editSection');
        editSection.innerHTML = '';
        cardsData.forEach(card => {
            const placeholder = card.type === 'pattern' ? 'å¯åœ¨æ­¤è™•ä¸€æ¬¡è²¼ä¸Šå¤šå€‹å¥å‹...' : 'å¯åœ¨æ­¤è™•ä¸€æ¬¡è²¼ä¸Šå¤šè¡Œæ–‡å­—...';
            const editGroup = document.createElement('div');
            editGroup.className = 'bg-slate-100 p-4 rounded-lg flex flex-col h-full';
            const wordListHtml = card.content.map((item) => `
                <div class="word-item" data-word="${item}"><span class="flex-grow truncate pr-2" title="${item}">${item}</span><button class="delete-btn" onclick="deleteWord('${card.id}', '${item}')">âŒ</button></div>
            `).join('');
            
            const showAiButton = card.type === 'text';
            const aiButtonHtml = showAiButton 
                ? `<button id="ai-gen-btn-${card.id}" class="ai-gen-btn" title="ä½¿ç”¨ AI ç”Ÿæˆ 10 å€‹ç¯„æœ¬" onclick="handleAiWordGeneration('${card.id}')">âœ¨</button>`
                : '';
            
            editGroup.innerHTML = `
                <div class="flex justify-between items-center mb-2 gap-2">
                    <input type="text" value="${card.title}" onchange="updateCardTitle('${card.id}', this.value)" class="category-title-input" placeholder="è«‹è¼¸å…¥é¡åˆ¥åç¨±">
                    <span id="word-count-${card.id}" class="text-sm text-slate-500 font-semibold">(${card.content.length})</span>
                    ${aiButtonHtml}
                    <span class="clear-all-btn" onclick="handleClearAllWords('${card.id}')">ğŸ—‘ï¸ æ¸…é™¤</span>
                </div>
                <div id="edit-list-${card.id}" class="flex-grow overflow-y-auto pr-2" style="max-height: 200px;">${wordListHtml}</div>
                <textarea id="add-input-${card.id}" class="batch-textarea" placeholder="${placeholder}"></textarea>
                <button class="w-full bg-blue-500 text-white p-2 mt-2 rounded-md hover:bg-blue-600 font-bold" onclick="addWords('${card.id}')">â• æ–°å¢</button>
            `;
            editSection.appendChild(editGroup);
        });
    }
    
    function updateCardTitle(cardId, newTitle) {
        const card = cardsData.find(c => c.id === cardId);
        if (card && newTitle.trim() !== '') {
            card.title = newTitle.trim();
            saveDataToLocal();
        } else {
            showAlert('é¡åˆ¥åç¨±ä¸å¯ç‚ºç©ºï¼', 'âš ï¸ è­¦å‘Š');
            renderEditSection();
        }
    }

    function deleteWord(cardId, wordToDelete) {
        const card = cardsData.find(c => c.id === cardId);
        card.content = card.content.filter(word => word !== wordToDelete);
        saveDataToLocal();
        rerenderCardList(cardId);
    }

    function addWords(cardId) {
        const card = cardsData.find(c => c.id === cardId);
        const textarea = document.getElementById(`add-input-${cardId}`);
        const newWords = textarea.value.trim().split('\n').map(w => w.trim()).filter(w => w);
        if (newWords.length > 0) {
            const uniqueNewWords = newWords.filter(w => !card.content.includes(w));
            card.content.push(...uniqueNewWords);
            textarea.value = '';
            saveDataToLocal();
            rerenderCardList(cardId);
        }
    }
    
    function rerenderCardList(cardId) {
        const card = cardsData.find(c => c.id === cardId);
        const wordListContainer = document.getElementById(`edit-list-${cardId}`);
        const wordCountSpan = document.getElementById(`word-count-${card.id}`);
        
        wordListContainer.innerHTML = card.content.map((item) => `
            <div class="word-item" data-word="${item}"><span class="flex-grow truncate pr-2" title="${item}">${item}</span><button class="delete-btn" onclick="deleteWord('${card.id}', '${item}')">âŒ</button></div>
        `).join('');
        wordCountSpan.textContent = `(${card.content.length})`;
    }

    function handleClearAllWords(cardId) {
        const cardTitle = cardsData.find(c => c.id === cardId).title;
        showConfirm(`ç¢ºå®šè¦æ¸…é™¤ã€Œ${cardTitle}ã€çš„æ‰€æœ‰å…§å®¹å—ï¼Ÿæ­¤å‹•ä½œæœƒç«‹å³å„²å­˜ã€‚`, () => {
            const card = cardsData.find(c => c.id === cardId);
            card.content = [];
            saveDataToLocal();
            rerenderCardList(cardId);
            showAlert(`ã€Œ${cardTitle}ã€çš„å…§å®¹å·²å…¨éƒ¨æ¸…é™¤ã€‚`);
        });
    }

    // --- éŠæˆ²é é¢ ---
    function renderGameCards() {
        const cardsGrid = document.getElementById('cardsGrid');
        cardsGrid.innerHTML = '';
        cardsData.forEach((card, index) => {
            if (card.type === 'pattern') return;
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'flex flex-col items-center';
            const isImageCard = card.type === 'image';
            cardWrapper.innerHTML = `
                <h3 class="text-xl font-bold text-slate-700 mb-2 h-8">${card.title}</h3>
                <div class="perspective w-full card-container">
                    <div class="flip-card-inner rounded-2xl cursor-pointer" data-index="${index}" data-id="${card.id}">
                        <div class="flip-card-front ${card.color} text-white"><h3 class="text-4xl font-bold">é»æˆ‘æŠ½ç‰Œ</h3></div>
                        <div class="flip-card-back ${card.backColor} flex-col text-slate-800">
                             <div class="content-fader w-full h-full flex items-center justify-center">
                                ${isImageCard ? 
                                    `<div class="relative w-full h-full"><img src="" alt="æ•…äº‹åœ–ç‰‡" class="story-image" data-content="" onerror="this.src='https://placehold.co/600x400/e2e8f0/64748b?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—'"><button class="zoom-btn absolute bottom-2 right-2 bg-black bg-opacity-40 text-white rounded-full w-10 h-10 text-2xl hidden items-center justify-center hover:bg-opacity-60 transition">ğŸ”</button></div>` :
                                    `<p class="text-6xl md:text-7xl font-bold p-4 break-all" data-content=""></p>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            cardsGrid.appendChild(cardWrapper);
            cardWrapper.querySelector('.flip-card-inner').addEventListener('click', (e) => handleCardClick(e.currentTarget));
        });
    }
    
    function handleCardClick(cardInnerElement) {
        if (cardInnerElement.isAnimating) return;
        cardInnerElement.isAnimating = true;

        flipSound.currentTime = 0;
        flipSound.play().catch(e => console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e));

        const index = parseInt(cardInnerElement.dataset.index);
        const isFlipped = cardInnerElement.classList.contains('is-flipped');
        const animationDuration = 600;

        const updateContent = () => {
            if (availableWords[index].length === 0) {
                if (cardsData[index].content.length === 0) {
                    const cardBack = cardInnerElement.querySelector('.flip-card-back');
                    const contentElem = cardBack.querySelector('[data-content]');
                    if (cardsData[index].type === 'image') contentElem.src = 'https://placehold.co/600x400/e2e8f0/64748b?text=ç„¡å…§å®¹';
                    else contentElem.textContent = 'ç„¡å…§å®¹';
                    contentElem.dataset.content = 'ç„¡å…§å®¹';
                    return;
                }
                availableWords[index] = [...cardsData[index].content].sort(() => Math.random() - 0.5);
            }
            
            const newContent = availableWords[index].pop();
            const cardData = cardsData[index];
            const cardBack = cardInnerElement.querySelector('.flip-card-back');
            const contentElem = cardBack.querySelector('[data-content]');
            contentElem.dataset.content = newContent;

            if (cardData.type === 'image') {
                contentElem.src = newContent;
                const zoomBtn = cardBack.querySelector('.zoom-btn');
                zoomBtn.onclick = (e) => { e.stopPropagation(); openImageModal(newContent); };
                zoomBtn.classList.remove('hidden');
                zoomBtn.classList.add('flex');
            } else {
                contentElem.textContent = newContent;
            }
            document.getElementById('aiBtn').disabled = false;
            document.getElementById('aiBtn').classList.remove('opacity-50', 'cursor-not-allowed');
        };

        if (isFlipped) {
            cardInnerElement.classList.remove('is-flipped');
            setTimeout(() => {
                updateContent();
                setTimeout(() => {
                    cardInnerElement.classList.add('is-flipped');
                    cardInnerElement.isAnimating = false;
                }, 50); 
            }, animationDuration / 2);
        } else {
            updateContent();
            cardInnerElement.classList.add('is-flipped');
            setTimeout(() => cardInnerElement.isAnimating = false, animationDuration);
        }
    }

    function flipAllCards() {
        document.querySelectorAll('.flip-card-inner').forEach((cardInner, i) => {
            setTimeout(() => { handleCardClick(cardInner); }, i * 150);
        });
    }

    function resetAllCards() {
        document.querySelectorAll('.flip-card-inner.is-flipped').forEach((cardInner, i) => {
            setTimeout(() => cardInner.classList.remove('is-flipped'), i * 100);
        });
        availableWords = cardsData.map(card => card.content.length > 0 ? [...card.content].sort(() => Math.random() - 0.5) : []);
        const aiBtn = document.getElementById('aiBtn');
        if (aiBtn) {
            aiBtn.disabled = true;
            aiBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        document.getElementById('aiSentenceOutput').innerHTML = '';
        lastGenerationParams = null; // v2.5.3: æ¸…é™¤ AI è¨­å®š
    }
    
    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        showModal(document.getElementById('imageModal'));
    }

    function closeImageModal(event) {
        if (event) event.stopPropagation();
        hideModal(document.getElementById('imageModal'));
        document.getElementById('modalImage').src = "";
    }

    function startGame() {
        availableWords = cardsData.map(card => card.content.length > 0 ? [...card.content].sort(() => Math.random() - 0.5) : []);
        document.getElementById('settingsPage').classList.remove('active');
        document.getElementById('gamePage').classList.add('active');
        document.getElementById('headerSubtitle').textContent = 'é»æ“Šå¡ç‰‡ç¿»é¢ï¼Œç²å¾—é€ å¥éˆæ„Ÿï¼';
        renderGameCards();
        if (!document.getElementById('aiBtn')) {
            const aiBtn = document.createElement('button');
            aiBtn.id = 'aiBtn';
            aiBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-full shadow-md hover:shadow-lg transition-transform transform hover:scale-105 opacity-50 cursor-not-allowed';
            aiBtn.textContent = 'ğŸ¤– AI é€ å¥æ”¹å¯«';
            aiBtn.disabled = true;
            aiBtn.onclick = openAiModal;
            const flipAllBtn = document.querySelector('#game-controls button:nth-child(2)');
            flipAllBtn.insertAdjacentElement('afterend', aiBtn);
        }
    }

    function backToSettings() {
        document.getElementById('gamePage').classList.remove('active');
        document.getElementById('settingsPage').classList.add('active');
        document.getElementById('headerSubtitle').textContent = 'é»æ“Šå¡ç‰‡ç¿»é¢ï¼Œçµ„åˆç„¡é™å‰µæ„ï¼';
        renderEditSection();
    }
    
    function handleResetToDefault() {
        showConfirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­å€¼å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è‡ªè¨‚å…§å®¹ä¸¦ç«‹å³å„²å­˜ã€‚', resetToDefault);
    }

    function resetToDefault() {
        cardsData = JSON.parse(JSON.stringify(defaultCards));
        saveDataToLocal();
        renderEditSection();
        showAlert('å·²æˆåŠŸé‡ç½®ç‚ºé è¨­å€¼ï¼');
    }

    function exportSettings() {
        const settings = { cardsData, exportDate: new Date().toISOString(), version: 'v2.0' };
        const dataStr = JSON.stringify(settings, null, 2);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
        link.download = `é›²æ•™å®¤é€ å¥ç¿»ç¿»ç‰Œè¨­å®š_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    function importSettings(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const settings = JSON.parse(e.target.result);
                const isValidCardsData = (data) => {
                    if (!data || !Array.isArray(data)) return false;
                    return data.every(card =>
                        typeof card === 'object' && card !== null &&
                        typeof card.id === 'string' &&
                        typeof card.title === 'string' &&
                        Array.isArray(card.content) &&
                        card.content.every(item => typeof item === 'string') &&
                        typeof card.type === 'string' &&
                        ['text', 'image', 'pattern'].includes(card.type)
                    );
                };
                if (settings && isValidCardsData(settings.cardsData)) {
                    cardsData = settings.cardsData;
                    saveDataToLocal(); 
                    renderEditSection();
                    showAlert('è¨­å®šæª”åŒ¯å…¥æˆåŠŸï¼è¨­å®šå·²è‡ªå‹•å„²å­˜ã€‚');
                } else {
                    showAlert('è¨­å®šæª”æ ¼å¼éŒ¯èª¤æˆ–ç¼ºå°‘å¿…è¦æ¬„ä½ï¼è«‹ç¢ºèªæª”æ¡ˆä¾†æºæ˜¯å¦æ­£ç¢ºï¼Œæˆ–æª”æ¡ˆå…§å®¹æ˜¯å¦ææ¯€ã€‚', 'âŒ åŒ¯å…¥å¤±æ•—');
                }
            } catch (error) {
                showAlert(`è¨­å®šæª”è®€å–æˆ–è§£æå¤±æ•—ï¼è«‹ç¢ºèªé€™æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON æª”æ¡ˆã€‚\néŒ¯èª¤è¨Šæ¯ï¼š${error.message}`, 'âŒ åŒ¯å…¥å¤±æ•—');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; 
    }
    
    // --- AI é€ å¥ Modal ---
    const aiModal = document.getElementById('aiModal');

    function toggleStoryDescription(checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        const textarea = document.getElementById(`desc-${checkboxId}`);
        if (textarea) textarea.classList.toggle('hidden', !checkbox.checked);
    }
    
    function openAiModal() {
        const flippedCards = document.querySelectorAll('.flip-card-inner.is-flipped');
        if (flippedCards.length === 0) {
            showAlert('è«‹å…ˆç¿»é–‹è‡³å°‘ä¸€å¼µå¡ç‰‡ï¼', 'ğŸ¤” å°æç¤º');
            return;
        }

        const wordSelectionArea = document.getElementById('aiWordSelection');
        wordSelectionArea.innerHTML = '';
        flippedCards.forEach((card, i) => {
            const cardId = card.dataset.id;
            const cardData = cardsData.find(c => c.id === cardId);
            const content = card.querySelector('.flip-card-back [data-content]').dataset.content;

            if (content === 'ç„¡å…§å®¹' || !content) return;

            const isImage = cardData.type === 'image';
            const inputId = `word-checkbox-${i}`;
            const textareaId = `desc-${inputId}`;
            const wrapper = document.createElement('div');

            wrapper.innerHTML = `
                <div class="form-checkbox-item">
                    <input type="checkbox" id="${inputId}" class="form-checkbox" data-type="${cardData.type}" data-content="${content}" ${isImage ? `onchange="toggleStoryDescription('${inputId}')"` : ''}>
                    <label for="${inputId}" class="text-slate-700 cursor-pointer">${isImage ? `ğŸ–¼ï¸ æ•…äº‹å¡` : content}</label>
                </div>
                ${isImage ? `<textarea id="${textareaId}" class="form-textarea text-sm mt-1 hidden" rows="2" placeholder="è«‹æè¿°åœ–ç‰‡æƒ…å¢ƒ..."></textarea>` : ''}
            `;
            wordSelectionArea.appendChild(wrapper);
        });

        const allTextCheckboxes = Array.from(wordSelectionArea.querySelectorAll('input[data-type="text"]'));
        document.querySelectorAll('#aiWordSelection input[type=checkbox]').forEach(cb => cb.checked = false);
        if (allTextCheckboxes.length > 0) {
            const randomIndex = Math.floor(Math.random() * allTextCheckboxes.length);
            allTextCheckboxes[randomIndex].checked = true;
        }

        const patternSelect = document.getElementById('aiPatternSelect');
        const patterns = cardsData.find(c => c.id === 'patterns')?.content || [];
        patternSelect.innerHTML = '<option value="">-- ç”±AIè‡ªç”±ç™¼æ® --</option>';
        patterns.forEach(p => patternSelect.innerHTML += `<option value="${p}">${p}</option>`);
        
        document.getElementById('aiPatternInput').value = '';
        showModal(aiModal);
    }

    function closeAiModal() { hideModal(aiModal); }
    
    // --- èªéŸ³æœ—è®€ ---
    function speakText(text, targetElementId) {
        if (!speechSynth) {
            showAlert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€åŠŸèƒ½ã€‚', 'âŒ åŠŸèƒ½ä¸æ”¯æ´');
            return;
        }
        if (speechSynth.speaking) {
            speechSynth.cancel();
            if (currentUtterance && currentUtterance.text === text) {
                currentUtterance = null;
                return;
            }
        }

        const targetElement = document.getElementById(targetElementId);
        if (targetElement) targetElement.innerHTML = text;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 1;
        utterance.pitch = 1;
        currentUtterance = utterance;
        utterance.onboundary = (event) => {
            if (event.name === 'word' && targetElement) {
                const charIndex = event.charIndex;
                const charLength = event.charLength;
                const spokenPart = text.substring(0, charIndex + charLength);
                const remainingPart = text.substring(charIndex + charLength);
                targetElement.innerHTML = `<span class="highlight-word">${spokenPart}</span>${remainingPart}`;
            }
        };
        utterance.onend = () => {
            if (targetElement) targetElement.innerHTML = text;
            currentUtterance = null;
        };
        utterance.onerror = (event) => {
            console.error('èªéŸ³åˆæˆç™¼ç”ŸéŒ¯èª¤:', event.error);
            if (targetElement) targetElement.innerHTML = text;
            currentUtterance = null;
        };
        speechSynth.speak(utterance);
    }

    // --- å¥å­æ”¾å¤§ Modal (v2.5.1 æ›´æ–°) ---
    function showSentenceModal(sentence, pattern, analysis, blocksJSON, posTagsJSON) {
        modalTitle.textContent = 'ğŸ” è©³ç´°å¥å­';
        let messageHtml = '';
        
        if (pattern) {
            messageHtml += `
            <div class="flex justify-between items-start mb-2">
                <span class="sentence-pattern">æ ¼å¼ï¼šã€${pattern}ã€‘</span>
                <span class="sentence-analysis-prompt">${analysis || ''}</span>
            </div>`;
        }
        
        const escapedSentence = sentence.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
        const escapedPattern = pattern.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
        const escapedBlocks = blocksJSON.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
        const escapedPosTags = posTagsJSON.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
        const sentenceId = `modal-sentence-${Date.now()}`;
        
        messageHtml += `
            <div class="flex items-start gap-4 pt-4">
                <p id="${sentenceId}" class="flex-grow text-2xl md:text-3xl font-semibold leading-relaxed text-left">${sentence}</p>
                <div class="flex flex-col gap-3 flex-shrink-0">
                    <button onclick="speakText('${escapedSentence}', '${sentenceId}')" class="sentence-action-btn" title="æœ—è®€å¥å­">ğŸ”Š</button>
                    <button onclick="openScrambleGame('${escapedSentence}', '${escapedPattern}', '${escapedBlocks}', '${escapedPosTags}')" class="sentence-action-btn" title="å¥å­é‡çµ„éŠæˆ²">ğŸ§©</button>
                </div>
            </div>
        `;
        modalMessage.innerHTML = messageHtml;
        modalActions.innerHTML = `<button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full" onclick="hideModal(customModal)">é—œé–‰</button>`;
        modalContent.classList.remove('max-w-md');
        modalContent.classList.add('max-w-4xl'); 
        showModal(customModal);
    }
    
    // --- AI æ ¸å¿ƒ (v2.5.3 é‡å¤§æ›´æ–°) ---
    
    /**
     * v2.5.3: é‡æ–°ç”Ÿæˆå–®ä¸€ AI å¥å­
     * @param {string} targetItemId - è¦æ›¿æ›å…§å®¹çš„ result-item çš„ ID
     */
    async function handleRegenerateSingleSentence(targetItemId) {
        const targetItem = document.getElementById(targetItemId);
        if (!targetItem) {
            console.error("æ‰¾ä¸åˆ°ç›®æ¨™é …ç›®:", targetItemId);
            return;
        }
        if (!lastGenerationParams) {
            showAlert('æ‰¾ä¸åˆ°ä¸Šæ¬¡çš„ç”Ÿæˆè¨­å®šï¼Œè«‹é‡æ–°é–‹å•Ÿ AI é€ å¥è¦–çª—ã€‚', 'âŒ éŒ¯èª¤');
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­...
        const originalHtml = targetItem.innerHTML;
        targetItem.innerHTML = `
            <div class="flex items-center justify-center h-full text-slate-500 font-semibold p-10">
                ğŸ§  é‡æ–°ç”Ÿæˆä¸­... 
                <svg class="animate-spin ml-2 h-5 w-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        `;

        // --- é‡å»º Prompt (v2.5.3) ---
        // å¾å„²å­˜çš„è¨­å®šä¸­å–å‡ºåƒæ•¸
        const { selectedWords, finalPattern, imageDescriptions, style, targetAudience, wordCount, isShortPhrase } = lastGenerationParams;
        
        let prompt = '';
        // ** v2.5.3 ä¿®æ”¹ï¼šè¦æ±‚ AI åªå›å‚³ 1 å€‹ç‰©ä»¶**
        const jsonOutputRequirement = `
**è¼¸å‡ºè¦æ±‚ (æ¥µé‡è¦)ï¼š**
è«‹**åš´æ ¼**ä»¥ JSON æ ¼å¼å›è¦†ã€‚å›è¦†ä¸€å€‹**åªåŒ…å« 1 å€‹ç‰©ä»¶**çš„é™£åˆ—ã€‚è©²ç‰©ä»¶å¿…é ˆåŒ…å«ï¼š
1.  \`sentence\`: (string) æœ€çµ‚ç”Ÿæˆçš„å®Œæ•´å¥å­ã€‚
2.  \`analysis\`: (string) é‡å°ã€Œåƒè€ƒå¥å‹ã€çš„ã€Œè©æ€§çµæ§‹åˆ†æã€æˆ–ã€Œèªæ„æç¤ºã€ã€‚
3.  \`blocks\`: (array of strings) ç”¨æ–¼ã€Œå¥å­é‡çµ„éŠæˆ²ã€çš„**è©å¡Šé™£åˆ—**ã€‚
4.  \`pos_tags\`: (array of strings) å°æ‡‰ \`blocks\` é™£åˆ—çš„ã€Œè©æ€§æ¨™ç±¤é™£åˆ—ã€ã€‚(\`blocks\` å’Œ \`pos_tags\` é™£åˆ—çš„é•·åº¦**å¿…é ˆ**å®Œå…¨ç›¸åŒ)ã€‚
`;

        if (isShortPhrase) {
            // ** v2.5.3 ä¿®æ”¹ï¼šè¦æ±‚ AI ç”¢ç”Ÿ 1 å€‹çµæœ**
            prompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€æŒ‡å°åœ‹å°å­¸ç”Ÿé€²è¡Œã€ŒçŸ­èªä»¿å¯«ã€çš„ä¸­æ–‡è€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯åš´æ ¼ä¾ç…§ä»¥ä¸‹ç¯„æœ¬çŸ­èªé€²è¡Œä»¿å¯«ï¼Œä¸¦ç”¢ç”Ÿ 1 å€‹ç¬¦åˆè¦å‰‡çš„çµæœã€‚\n\n**ç¯„æœ¬çŸ­èªï¼š**\n"${finalPattern}"`;
            if (selectedWords.length > 0) {
                prompt += `\n\n**æŒ‡å®šèªè© (å¯é¸ç”¨)ï¼š**\nè«‹å˜—è©¦åœ¨ä½ çš„ä»¿å¯«çµæœä¸­ï¼Œä½¿ç”¨ä¸€å€‹ä¾†è‡ªæ¸…å–®ã€${selectedWords.join('ã€')}ã€‘ä¸­çš„èªè©ä¾†æ›¿æ›æ‹¬è™Ÿå…§çš„å…§å®¹ã€‚`;
            }
            prompt += `\n\n**ä»¿å¯«è¦å‰‡ (æ¥µé‡è¦ï¼Œå¿…é ˆåš´æ ¼éµå®ˆ)ï¼š**\n1.  **åƒ…æ›¿æ›è©èªï¼š** ä½ çš„å›è¦†ä¸­ï¼Œçµ•å°åªèƒ½æ›¿æ›å…¨å½¢æ‹¬è™Ÿã€Œï¼ˆï¼‰ã€æˆ–åŠå½¢æ‹¬è™Ÿ "()" å…§çš„è©èªã€‚\n2.  **ä¿ç•™çµæ§‹ï¼š** æ‹¬è™Ÿå¤–çš„æ‰€æœ‰æ–‡å­—ã€ç¬¦è™Ÿéƒ½å¿…é ˆä¸€å­—ä¸æ”¹åœ°ä¿ç•™åœ¨åŸä½ã€‚\n3.  **ä¿ç•™æ‹¬è™Ÿï¼š** \`sentence\` æ¬„ä½è¼¸å‡ºçš„å¥å­**å¿…é ˆ**ä¿ç•™æ‹¬è™Ÿã€‚\n`;
            
            prompt += jsonOutputRequirement;
            prompt += `
**JSON æ¬„ä½è¦å‰‡ (çŸ­èªä»¿å¯«)ï¼š**
* \`sentence\`: å¿…é ˆåŒ…å«æ‹¬è™Ÿã€‚ä¾‹ï¼š"ï¼ˆæœˆå…‰ï¼‰ï¼ˆç‘æ»¿ï¼‰äº†ï¼ˆæµ·æ´‹ï¼‰ã€‚"
* \`analysis\`: é‡å°æ‹¬è™Ÿå…§çš„è©æ€§åˆ†æã€‚ä¾‹ï¼š"åè© + å‹•è© + åŠ©è© + åè©"
* \`blocks\`: **ä¸åŒ…å«**æ‹¬è™Ÿï¼Œä¸”ä¾èªæ„æ‹†åˆ†ã€‚ä¾‹ï¼š["æœˆå…‰", "ç‘æ»¿", "äº†", "æµ·æ´‹", "ã€‚"]
* \`pos_tags\`: å°æ‡‰ \`blocks\` çš„è©æ€§ã€‚ä¾‹ï¼š["åè©", "å‹•è©", "åŠ©è©", "åè©", "æ¨™é»"]
`;
        } else {
            prompt = `ä½ æ˜¯ä¸€ä½ã€Œåœ‹å°é€ å¥é«˜æ‰‹è€å¸«ã€ï¼Œå°ˆé–€æŒ‡å° 10-12 æ­²çš„å°å­¸ç”Ÿç·´ç¿’é€ å¥ã€‚\n\n`;
            // ** v2.5.3 ä¿®æ”¹ï¼šè¦æ±‚ AI å‰µä½œ 1 å€‹ä¾‹å¥**
            prompt += `**ä»»å‹™ï¼š** è«‹æ ¹æ®ä»¥ä¸‹ã€Œæ ¸å¿ƒå…ƒç´ ã€èˆ‡ã€Œè¼”åŠ©è¨­å®šã€ï¼Œå‰µä½œ 1 å€‹é€šé †ä¸”é«˜å“è³ªçš„ä¾‹å¥ã€‚\n\n`;
            prompt += `--- æ ¸å¿ƒå…ƒç´  (å¿…é ˆåš´æ ¼éµå®ˆ) ---\n`;
            if (selectedWords.length > 0) {
                prompt += `**å¿…é ˆä½¿ç”¨çš„èªè©ï¼š** "${selectedWords.join('", "')}"\n`;
            }
            if (finalPattern) {
                const patternType = (finalPattern.includes('...')) ? 'å¥å‹' : 'é—œéµè©';
                prompt += `**åƒè€ƒçš„${patternType}ï¼š** "${finalPattern}"\n`;
            }
            if (imageDescriptions.length > 0) {
                prompt += `**éœ€èå…¥çš„æƒ…å¢ƒï¼š** "${imageDescriptions.join('", "')}"\n`;
            }
            prompt += `\n--- è¼”åŠ©è¨­å®š ---\n`;
            prompt += `**ç›®æ¨™å¹´ç´šï¼š** åœ‹å°${targetAudience}\n`;
            prompt += `**å¥å­é¢¨æ ¼ï¼š** ${style}\n`;
            if (wordCount !== 'unlimited') {
                switch (wordCount) {
                    case '15-30': prompt += `**å­—æ•¸è¦æ±‚ï¼š** å¥å­é•·åº¦ç´„ 15 åˆ° 30 å€‹å­—ã€‚\n`; break;
                    case '30+': prompt += `**å­—æ•¸è¦æ±‚ï¼š** å¥å­é•·åº¦ 30 å€‹å­—ä»¥ä¸Šã€‚\n`; break;
                }
            }
            prompt += `\n--- è¡Œç‚ºæº–å‰‡ (æ¥µé‡è¦ï¼) ---\n`;
            prompt += `1. **æº–ç¢ºæ€§ (æœ€é‡è¦)ï¼š** ä½ çš„é€ å¥ã€Œå¿…é ˆã€å®Œæ•´åŒ…å«ã€Œå¿…é ˆä½¿ç”¨çš„èªè©ã€æ¸…å–®ä¸­çš„ã€Œæ‰€æœ‰ã€è©èªã€‚å¦‚æœæ²’æœ‰ã€Œå¿…é ˆä½¿ç”¨çš„èªè©ã€ï¼Œå‰‡å¿…é ˆæ­£ç¢ºä½¿ç”¨ã€Œåƒè€ƒçš„å¥å‹ã€æˆ–åœç¹ã€Œåƒè€ƒçš„é—œéµè©ã€ä¾†é€ å¥ã€‚\n`;
            prompt += `2. **èªæ„Ÿè‡ªç„¶ã€è²¼è¿‘ç”Ÿæ´»ã€‚**\n`;
            prompt += `3. **å¥å­ä¸æ‡‰åŒ…å«æ‹¬è™Ÿã€‚**\n`;

            prompt += jsonOutputRequirement;
            prompt += `
**JSON æ¬„ä½è¦å‰‡ (ä¸€èˆ¬é€ å¥)ï¼š**
* \`sentence\`: **ä¸åŒ…å«**æ‹¬è™Ÿã€‚ä¾‹ï¼š"é€™å¹…ç•«å‡¸é¡¯äº†ç•«å®¶çš„æŠ€å·§ã€‚"
* \`analysis\`: é‡å°å¥å­çš„çµæ§‹åˆ†æã€‚
* \`blocks\`: å¿…é ˆå°‡å¥å­æ‹†åˆ†ç‚º **3 åˆ° 7 å€‹ã€Œæœ‰æ„ç¾©çš„èªç¾©è©å¡Šã€**ã€‚ (é‡é»èªè©/å¥å‹é—œéµå­—å¿…é ˆç¨ç«‹ç‚ºè©å¡Š)
* \`pos_tags\`: å°æ‡‰ \`blocks\` çš„è©æ€§ã€‚
`;
        }
        // --- Prompt é‡å»ºå®Œç•¢ ---

        try {
            const resultText = await callGeminiApi(prompt, true);
            let results = [];
            try {
                const cleanedJsonString = resultText.replace(/^```json\s*|```\s*$/g, '');
                results = JSON.parse(cleanedJsonString);
            } catch (e) {
                // å¦‚æœ AI é‚„æ˜¯å›å‚³ç´”æ–‡å­—
                results = [{ sentence: resultText, analysis: '', blocks: [], pos_tags: [] }];
            }
            
            // ** v2.5.3 ä¿®æ”¹ï¼šåªéœ€è¦ç¬¬ä¸€å€‹çµæœ**
            const result = results[0];
            if (!result) throw new Error("AI æœªå›å‚³æœ‰æ•ˆçµæœã€‚");

            const sentence = result.sentence || "AI å›å‚³æ ¼å¼éŒ¯èª¤";
            const analysis = result.analysis || '';
            const blocks = result.blocks || [];
            const posTags = result.pos_tags || [];
            
            const escapedSentence = sentence.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
            const escapedPattern = finalPattern.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
            const escapedAnalysis = analysis.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
            const escapedBlocks = JSON.stringify(blocks).replace(/"/g, '&quot;').replace(/'/g, '\\\'');
            const escapedPosTags = JSON.stringify(posTags).replace(/"/g, '&quot;').replace(/'/g, '\\\'');
            
            // ç”¢ç”Ÿæ–°çš„å”¯ä¸€ ID çµ¦æœ—è®€åŠŸèƒ½
            const sentenceId = `sentence-output-${Date.now()}`; 
            
            // ** v2.5.3 ä¿®æ”¹ï¼šé‡å»ºå¡ç‰‡ HTML **
            let itemHtml = '';
            itemHtml += `<div class="result-item-content" onclick="showSentenceModal('${escapedSentence}', '${escapedPattern}', '${escapedAnalysis}', '${escapedBlocks}', '${escapedPosTags}')">`;
            
            if (finalPattern) {
                itemHtml += `
                <div class="flex justify-between items-start">
                    <span class="sentence-pattern">æ ¼å¼ï¼šã€${finalPattern}ã€‘</span>
                    <span class="sentence-analysis-prompt">${analysis}</span>
                </div>`;
            }
            
            itemHtml += `<div id="${sentenceId}" class="sentence-text">${sentence}</div>`;
            itemHtml += `</div>`; // çµæŸ .result-item-content
            
            itemHtml += `<div class="sentence-actions">
                <button onclick="speakText('${escapedSentence}', '${sentenceId}')" class="sentence-action-btn" title="æœ—è®€å¥å­">ğŸ”Š</button>
                <button onclick="openScrambleGame('${escapedSentence}', '${escapedPattern}', '${escapedBlocks}', '${escapedPosTags}')" class="sentence-action-btn" title="å¥å­é‡çµ„éŠæˆ²">ğŸ§©</button>
                <button onclick="handleRegenerateSingleSentence('${targetItemId}')" class="sentence-action-btn" title="é‡æ–°ç”Ÿæˆæ­¤å¥">ğŸ”„</button>
            </div>`;
            
            targetItem.innerHTML = itemHtml; // æ›¿æ›å…§å®¹

        } catch (error) {
            showAlert(`é‡æ–°ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'âŒ éŒ¯èª¤');
            targetItem.innerHTML = originalHtml; // ç™¼ç”ŸéŒ¯èª¤æ™‚é‚„åŸ
        }
    }


    async function handleGenerateSentences() {
        const sentenceOutput = document.getElementById('aiSentenceOutput');
        const generateBtn = document.getElementById('aiGenerateBtn');

        generateBtn.disabled = true;
        generateBtn.innerHTML = `ğŸ§  æ€è€ƒä¸­... <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

        const patternInput = document.getElementById('aiPatternInput').value.trim();
        const patternSelect = document.getElementById('aiPatternSelect').value;
        const finalPattern = patternInput || patternSelect;

        const selectedWords = [];
        const imageDescriptions = [];
        document.querySelectorAll('#aiWordSelection input[type=checkbox]:checked').forEach(cb => {
            if (cb.dataset.type !== 'image') {
                selectedWords.push(cb.dataset.content);
            } else {
                const desc = document.getElementById(`desc-${cb.id}`)?.value.trim();
                if (desc) imageDescriptions.push(desc);
            }
        });

        if (selectedWords.length === 0 && !finalPattern && imageDescriptions.length === 0) {
            showAlert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹èªè©ã€æŒ‡å®šå¥å‹æˆ–æè¿°åœ–ç‰‡æƒ…å¢ƒï¼', 'ğŸ¤” è«‹æä¾›é€ å¥ç´ æ');
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'ğŸš€ ç”¢ç”Ÿå¥å­';
            return; 
        }

        const style = document.getElementById('aiStyleSelect').value;
        const gradeLevel = document.querySelector('input[name="grade"]:checked').value;
        const wordCount = document.querySelector('input[name="wordCount"]:checked').value;
        const gradeMap = { low: 'ä½å¹´ç´š', middle: 'ä¸­å¹´ç´š', high: 'é«˜å¹´ç´š' };
        const targetAudience = gradeMap[gradeLevel];
        const isShortPhrase = ( (finalPattern.includes('(') && finalPattern.includes(')')) || (finalPattern.includes('ï¼ˆ') && finalPattern.includes('ï¼‰')) );

        // --- v2.5.3: å„²å­˜ç”Ÿæˆè¨­å®š ---
        lastGenerationParams = {
            selectedWords: selectedWords,
            finalPattern: finalPattern,
            imageDescriptions: imageDescriptions,
            style: style,
            targetAudience: targetAudience,
            wordCount: wordCount,
            isShortPhrase: isShortPhrase
        };
        // --- çµæŸå„²å­˜ ---
        
        let prompt = '';
        // ** v2.5.3 ä¿®æ”¹ï¼šè¦æ±‚ AI å›å‚³ 3 å€‹ç‰©ä»¶**
        const jsonOutputRequirement = `
**è¼¸å‡ºè¦æ±‚ (æ¥µé‡è¦)ï¼š**
è«‹**åš´æ ¼**ä»¥ JSON æ ¼å¼å›è¦†ã€‚å›è¦†ä¸€å€‹åŒ…å« 3 å€‹ç‰©ä»¶çš„é™£åˆ—ã€‚æ¯å€‹ç‰©ä»¶å¿…é ˆåŒ…å«ï¼š
1.  \`sentence\`: (string) æœ€çµ‚ç”Ÿæˆçš„å®Œæ•´å¥å­ã€‚
2.  \`analysis\`: (string) é‡å°ã€Œåƒè€ƒå¥å‹ã€çš„ã€Œè©æ€§çµæ§‹åˆ†æã€æˆ–ã€Œèªæ„æç¤ºã€ã€‚
3.  \`blocks\`: (array of strings) ç”¨æ–¼ã€Œå¥å­é‡çµ„éŠæˆ²ã€çš„**è©å¡Šé™£åˆ—**ã€‚
4.  \`pos_tags\`: (array of strings) å°æ‡‰ \`blocks\` é™£åˆ—çš„ã€Œè©æ€§æ¨™ç±¤é™£åˆ—ã€ã€‚(\`blocks\` å’Œ \`pos_tags\` é™£åˆ—çš„é•·åº¦**å¿…é ˆ**å®Œå…¨ç›¸åŒ)ã€‚
`;

        if (isShortPhrase) {
            prompt = `ä½ æ˜¯ä¸€ä½å°ˆé–€æŒ‡å°åœ‹å°å­¸ç”Ÿé€²è¡Œã€ŒçŸ­èªä»¿å¯«ã€çš„ä¸­æ–‡è€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯åš´æ ¼ä¾ç…§ä»¥ä¸‹ç¯„æœ¬çŸ­èªé€²è¡Œä»¿å¯«ï¼Œä¸¦ç”¢ç”Ÿ 3 å€‹ç¬¦åˆè¦å‰‡çš„çµæœã€‚\n\n**ç¯„æœ¬çŸ­èªï¼š**\n"${finalPattern}"`;
            if (selectedWords.length > 0) {
                prompt += `\n\n**æŒ‡å®šèªè© (å¿…é ˆä½¿ç”¨)ï¼š**\nè«‹å‹™å¿…åœ¨ä½ çš„ä»¿å¯«çµæœä¸­ï¼Œä¸‰å¥è‡³å°‘æœ‰ä¸€å¥ä½¿ç”¨ä¸€å€‹ä¾†è‡ªæ¸…å–®ã€${selectedWords.join('ã€')}ã€‘ä¸­çš„æœ‰å‹¾é¸çš„èªè©ä¾†æ›¿æ›æ‹¬è™Ÿå…§çš„å…§å®¹ã€‚`;
            }
            prompt += `\n\n**ä»¿å¯«è¦å‰‡ (æ¥µé‡è¦ï¼Œå¿…é ˆåš´æ ¼éµå®ˆ)ï¼š**\n1.  **åƒ…æ›¿æ›è©èªï¼š** ä½ çš„å›è¦†ä¸­ï¼Œçµ•å°åªèƒ½æ›¿æ›å…¨å½¢æ‹¬è™Ÿã€Œï¼ˆï¼‰ã€æˆ–åŠå½¢æ‹¬è™Ÿ "()" å…§çš„è©èªã€‚\n2.  **ä¿ç•™çµæ§‹ï¼š** æ‹¬è™Ÿå¤–çš„æ‰€æœ‰æ–‡å­—ã€ç¬¦è™Ÿéƒ½å¿…é ˆä¸€å­—ä¸æ”¹åœ°ä¿ç•™åœ¨åŸä½ã€‚\n3.  **ä¿ç•™æ‹¬è™Ÿï¼š** \`sentence\` æ¬„ä½è¼¸å‡ºçš„å¥å­**å¿…é ˆ**ä¿ç•™æ‹¬è™Ÿã€‚\n`;
            
            prompt += jsonOutputRequirement;
            prompt += `
**JSON æ¬„ä½è¦å‰‡ (çŸ­èªä»¿å¯«)ï¼š**
* \`sentence\`: å¿…é ˆåŒ…å«æ‹¬è™Ÿã€‚ä¾‹ï¼š"ï¼ˆæœˆå…‰ï¼‰ï¼ˆç‘æ»¿ï¼‰äº†ï¼ˆæµ·æ´‹ï¼‰ã€‚"
* \`analysis\`: é‡å°æ‹¬è™Ÿå…§çš„è©æ€§åˆ†æã€‚ä¾‹ï¼š"åè© + å‹•è© + åŠ©è© + åè©"
* \`blocks\`: **ä¸åŒ…å«**æ‹¬è™Ÿï¼Œä¸”ä¾èªæ„æ‹†åˆ†ã€‚ä¾‹ï¼š["æœˆå…‰", "ç‘æ»¿", "äº†", "æµ·æ´‹", "ã€‚"]
* \`pos_tags\`: å°æ‡‰ \`blocks\` çš„è©æ€§ã€‚ä¾‹ï¼š["åè©", "å‹•è©", "åŠ©è©", "åè©", "æ¨™é»"]

**JSON ç¯„ä¾‹ï¼š**
[
  {
    "sentence": "ï¼ˆæœˆå…‰ï¼‰ï¼ˆç‘æ»¿ï¼‰äº†ï¼ˆæµ·æ´‹ï¼‰ã€‚",
    "analysis": "åè© + å‹•è© + åŠ©è© + åè©",
    "blocks": ["æœˆå…‰", "ç‘æ»¿", "äº†", "æµ·æ´‹", "ã€‚"],
    "pos_tags": ["åè©", "å‹•è©", "åŠ©è©", "åè©", "æ¨™é»"]
  }
]
`;
        } 
        else {
            prompt = `ä½ æ˜¯ä¸€ä½ã€Œåœ‹å°é€ å¥é«˜æ‰‹è€å¸«ã€ï¼Œå°ˆé–€æŒ‡å° 10-12 æ­²çš„å°å­¸ç”Ÿç·´ç¿’é€ å¥ã€‚ä½ ç†Ÿæ‚‰åœ‹èªæ–‡æ•™å­¸ï¼Œæ“…é•·ä»¥ç”Ÿæ´»åŒ–ã€å…·å•Ÿç™¼æ€§çš„ä¾‹å¥ï¼Œå¹«åŠ©å­¸ç”Ÿç†è§£ä¸¦æ­£ç¢ºé‹ç”¨çŸ­èªã€å¥å‹èˆ‡èªè©ã€‚\n\n`;
            prompt += `**ä»»å‹™ï¼š** è«‹æ ¹æ“šä»¥ä¸‹ã€Œæ ¸å¿ƒå…ƒç´ ã€èˆ‡ã€Œè¼”åŠ©è¨­å®šã€ï¼Œå‰µä½œ 3 å€‹é€šé †ä¸”é«˜å“è³ªçš„ä¾‹å¥ã€‚\n\n`;
            prompt += `--- æ ¸å¿ƒå…ƒç´  (å¿…é ˆåš´æ ¼éµå®ˆ) ---\n`;
            if (selectedWords.length > 0) {
                prompt += `**å¿…é ˆä½¿ç”¨çš„èªè©ï¼š** "${selectedWords.join('", "')}"\n`;
            }
            if (finalPattern) {
                const patternType = (finalPattern.includes('...')) ? 'å¥å‹' : 'é—œéµè©';
                prompt += `**åƒè€ƒçš„${patternType}ï¼š** "${finalPattern}"\n`;
            }
            if (imageDescriptions.length > 0) {
                prompt += `**éœ€èå…¥çš„æƒ…å¢ƒï¼š** "${imageDescriptions.join('", "')}"\n`;
            }
            prompt += `\n--- è¼”åŠ©è¨­å®š ---\n`;
            prompt += `**ç›®æ¨™å¹´ç´šï¼š** åœ‹å°${targetAudience}\n`;
            prompt += `**å¥å­é¢¨æ ¼ï¼š** ${style}\n`;
            if (wordCount !== 'unlimited') {
                switch (wordCount) {
                    case '15-30': prompt += `**å­—æ•¸è¦æ±‚ï¼š** æ¯å€‹å¥å­é•·åº¦ç´„ 15 åˆ° 30 å€‹å­—ã€‚\n`; break;
                    case '30+': prompt += `**å­—æ•¸è¦æ±‚ï¼š** æ¯å€‹å¥å­é•·åº¦ 30 å€‹å­—ä»¥ä¸Šã€‚\n`; break;
                }
            }
            prompt += `\n--- è¡Œç‚ºæº–å‰‡ (æ¥µé‡è¦ï¼) ---\n`;
            prompt += `1. **æº–ç¢ºæ€§ (æœ€é‡è¦)ï¼š** ä½ çš„é€ å¥ã€Œå¿…é ˆã€å®Œæ•´åŒ…å«ã€Œå¿…é ˆä½¿ç”¨çš„èªè©ã€æ¸…å–®ä¸­çš„ã€Œæ‰€æœ‰ã€è©èªã€‚å¦‚æœæ²’æœ‰ã€Œå¿…é ˆä½¿ç”¨çš„èªè©ã€ï¼Œå‰‡å¿…é ˆæ­£ç¢ºä½¿ç”¨ã€Œåƒè€ƒçš„å¥å‹ã€æˆ–åœç¹ã€Œåƒè€ƒçš„é—œéµè©ã€ä¾†é€ å¥ã€‚\n`;
            prompt += `2. **èªæ„Ÿè‡ªç„¶ã€è²¼è¿‘ç”Ÿæ´»ï¼š** å¥å­è¦åƒåœ‹å°${targetAudience}å­¸ç”Ÿæœƒèªªæˆ–å¯«çš„è©±ï¼Œé¿å…è‰±æ·±è©å½™æˆ–æˆäººèªæ°£ã€‚\n`;
            prompt += `3. **(v2.5.1 ä¿®æ­£) å¥å­ä¸æ‡‰åŒ…å«æ‹¬è™Ÿï¼š** \`sentence\` æ¬„ä½è¼¸å‡ºçš„å¥å­**ä¸æ‡‰è©²**åŒ…å«ä»»ä½• \`()\` æˆ– \`ï¼ˆï¼‰\`ã€‚\n`;

            prompt += jsonOutputRequirement;
            prompt += `
**JSON æ¬„ä½è¦å‰‡ (ä¸€èˆ¬é€ å¥)ï¼š**
* \`sentence\`: **ä¸åŒ…å«**æ‹¬è™Ÿã€‚ä¾‹ï¼š"é€™å¹…ç•«å‡¸é¡¯äº†ç•«å®¶çš„æŠ€å·§ã€‚"
* \`analysis\`: é‡å°å¥å­çš„çµæ§‹åˆ†æã€‚ä¾‹ï¼š"åè© + å‹•è© + åŠ©è© + åè©"
* \`blocks\`: **(v2.5.1 ä¿®æ­£)** å¿…é ˆå°‡å¥å­æ‹†åˆ†ç‚º **3 åˆ° 7 å€‹ã€Œæœ‰æ„ç¾©çš„èªç¾©è©å¡Šã€**ã€‚
    * (é‡é»èªè©) å¦‚æœæ˜¯ã€Œèªè©é€ å¥ã€(å¦‚ "å‡¸é¡¯")ï¼Œè©²ã€Œèªè©ã€**å¿…é ˆ**è‡ªå·±ç¨ç«‹ç‚ºä¸€å€‹è©å¡Šã€‚
    * (é‡é»èªè©) å¦‚æœæ˜¯ã€Œå¥å‹é€ å¥ã€(å¦‚ "é™¤äº†...ä¹Ÿ..."), \`é™¤äº†\` å’Œ \`ä¹Ÿ\` **å¿…é ˆ**å„è‡ªç¨ç«‹ç‚ºä¸€å€‹è©å¡Šã€‚
    * ä¾‹ 1 (èªè©)ï¼š"é€™å¹…ç•«å‡¸é¡¯äº†ç•«å®¶çš„æŠ€å·§ã€‚" -> \`blocks\` æ‡‰ç‚ºï¼š["é€™å¹…ç•«", "å‡¸é¡¯", "äº†", "ç•«å®¶çš„æŠ€å·§", "ã€‚"]
    * ä¾‹ 2 (å¥å‹)ï¼š"ä»–é™¤äº†åŠŸèª²å¾ˆå¥½ï¼Œä¹Ÿå¾ˆæœƒé‹å‹•ã€‚" -> \`blocks\` æ‡‰ç‚ºï¼š["ä»–", "é™¤äº†", "åŠŸèª²å¾ˆå¥½", "ï¼Œ", "ä¹Ÿ", "å¾ˆæœƒé‹å‹•", "ã€‚"]
* \`pos_tags\`: å°æ‡‰ \`blocks\` çš„è©æ€§ã€‚

**JSON ç¯„ä¾‹ï¼š**
[
  {
    "sentence": "é€™å¹…ç•«å‡¸é¡¯äº†ç•«å®¶çš„ç²¾æ¹›æŠ€å·§ã€‚",
    "analysis": "åè© + å‹•è© + åŠ©è© + åè©",
    "blocks": ["é€™å¹…ç•«", "å‡¸é¡¯", "äº†", "ç•«å®¶çš„ç²¾æ¹›æŠ€å·§", "ã€‚"],
    "pos_tags": ["åè©", "å‹•è©", "åŠ©è©", "åè©", "æ¨™é»"]
  }
]
`;
        }

        try {
            const resultText = await callGeminiApi(prompt, true); 
            let results = [];

            try {
                const cleanedJsonString = resultText.replace(/^```json\s*|```\s*$/g, '');
                results = JSON.parse(cleanedJsonString);
                if (!Array.isArray(results) || results.length === 0) throw new Error("JSON æ ¼å¼ä¸ç¬¦ï¼Œä¸¦éé™£åˆ—æˆ–ç‚ºç©ºã€‚");
            } catch (e) {
                console.error("AI æœªå›å‚³æœ‰æ•ˆ JSONï¼Œå°‡å˜—è©¦ç´”æ–‡å­—è§£æ:", e, resultText);
                const sentences = resultText.split('\n').filter(s => s.trim() !== '');
                results = sentences.map(s => ({
                    sentence: s,
                    analysis: '', 
                    blocks: [], 
                    pos_tags: []  
                }));
            }

            closeAiModal();
            sentenceOutput.innerHTML = `<h3 class="text-2xl font-bold text-slate-700 mb-4 text-center">âœ¨ AI é€ å¥çµæœ (é»æ“Šå¯æ”¾å¤§) âœ¨</h3>`;
            
            results.forEach((result, index) => {
                const sentence = result.sentence || "AI å›å‚³æ ¼å¼éŒ¯èª¤";
                const analysis = result.analysis || '';
                const blocks = result.blocks || [];
                const posTags = result.pos_tags || [];
                
                // --- v2.5.3: è³¦äºˆå¡ç‰‡å”¯ä¸€çš„ ID ---
                const parentItemId = `result-item-${Date.now() + index}`;
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.id = parentItemId; // è¨­å®šå¡ç‰‡ ID
                
                const escapedSentence = sentence.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
                const escapedPattern = finalPattern.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
                const escapedAnalysis = analysis.replace(/"/g, '&quot;').replace(/'/g, '\\\'');
                const escapedBlocks = JSON.stringify(blocks).replace(/"/g, '&quot;').replace(/'/g, '\\\'');
                const escapedPosTags = JSON.stringify(posTags).replace(/"/g, '&quot;').replace(/'/g, '\\\'');
                
                const sentenceId = `sentence-output-${index}`; // æœ—è®€ç”¨çš„ ID

                let itemHtml = '';
                
                itemHtml += `<div class="result-item-content" onclick="showSentenceModal('${escapedSentence}', '${escapedPattern}', '${escapedAnalysis}', '${escapedBlocks}', '${escapedPosTags}')">`;
                
                if (finalPattern) {
                    itemHtml += `
                    <div class="flex justify-between items-start">
                        <span class="sentence-pattern">æ ¼å¼ï¼šã€${finalPattern}ã€‘</span>
                        <span class="sentence-analysis-prompt">${analysis}</span>
                    </div>`;
                }
                
                itemHtml += `<div id="${sentenceId}" class="sentence-text">${sentence}</div>`;
                itemHtml += `</div>`;
                
                // --- v2.5.3: æ–°å¢é‡æ–°ç”ŸæˆæŒ‰éˆ• ---
                itemHtml += `<div class="sentence-actions">
                    <button onclick="speakText('${escapedSentence}', '${sentenceId}')" class="sentence-action-btn" title="æœ—è®€å¥å­">ğŸ”Š</button>
                    <button onclick="openScrambleGame('${escapedSentence}', '${escapedPattern}', '${escapedBlocks}', '${escapedPosTags}')" class="sentence-action-btn" title="å¥å­é‡çµ„éŠæˆ²">ğŸ§©</button>
                    <button onclick="handleRegenerateSingleSentence('${parentItemId}')" class="sentence-action-btn" title="é‡æ–°ç”Ÿæˆæ­¤å¥">ğŸ”„</button>
                </div>`;
                
                resultItem.innerHTML = itemHtml;
                sentenceOutput.appendChild(resultItem);
            });
            sentenceOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            showAlert(`ç³Ÿç³•ï¼AI é€ å¥å¤±æ•—äº†ï¼š${error.message}`, 'âŒ éŒ¯èª¤');
            lastGenerationParams = null; // å¤±æ•—æ™‚æ¸…é™¤
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸš€ é‡æ–°ç”¢ç”Ÿ';
        }
    }
    
    // --- AI è©å½™ç”Ÿæˆ (v2.5.1 ä¿®æ­£) ---
    async function handleAiWordGeneration(cardId) {
        const card = cardsData.find(c => c.id === cardId);
        if (!card) return;

        showConfirm(`ç¢ºå®šè¦ä½¿ç”¨ AI ç‚ºã€Œ${card.title}ã€ç”Ÿæˆ 10 å€‹æ–°è©å½™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹ç¾æœ‰åˆ—è¡¨ä¸¦ç«‹å³å„²å­˜ã€‚`, async () => {
            const aiBtn = document.getElementById(`ai-gen-btn-${cardId}`);
            const originalContent = aiBtn.innerHTML;
            aiBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            aiBtn.disabled = true;

            const categoryName = card.title.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, '').trim();
            const prompt = `ä½ æ˜¯ä¸€ä½åœ‹å°è€å¸«ï¼Œè«‹ç‚ºã€Œ${categoryName}ã€é€™å€‹é€ å¥é¡åˆ¥ï¼Œéš¨æ©Ÿç”¢ç”Ÿ 10 å€‹é©åˆåœ‹å°å­¸ç”Ÿçš„è©èªã€‚
**è¼¸å‡ºè¦æ±‚ï¼š** è«‹ç›´æ¥ç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”ã€‚**çµ•å°ä¸è¦**åŒ…å«ä»»ä½•æ¨™é¡Œã€ç·¨è™Ÿ (å¦‚ 1., 2.)ã€é …ç›®ç¬¦è™Ÿ (å¦‚ -, *) æˆ–ä»»ä½•èªªæ˜æ–‡å­—ã€‚`;

            try {
                const resultText = await callGeminiApi(prompt); 
                const newWords = resultText.split('\n')
                    .map(w => w.replace(/^[0-9]+\.\s*|^[-*]\s*/, '').trim()) 
                    .filter(w => w);
                
                card.content = newWords;
                saveDataToLocal();
                rerenderCardList(cardId);
                showAlert(`å·²æˆåŠŸç‚ºã€Œ${card.title}ã€ç”Ÿæˆ 10 å€‹æ–°è©å½™ï¼`);
            } catch (error) {
                showAlert(`AI ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'âŒ éŒ¯èª¤');
            } finally {
                aiBtn.innerHTML = originalContent;
                aiBtn.disabled = false;
            }
        });
    }

    // --- AI åˆ†æ Modal ---
    function openAnalysisModal() {
        loadAnalysisDataFromLocal();
        const importSelect = document.getElementById('analysisImportSelect');
        importSelect.innerHTML = cardsData.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
        
        const hasResults = !!document.getElementById('analysisResultText').value.trim();
        document.getElementById('analysisImportBtn').disabled = !hasResults;
        
        showModal(analysisModal);
    }

    function closeAnalysisModal() { hideModal(analysisModal); }
    
    document.getElementById('analysisSourceFile').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('analysisSourceText').value = e.target.result;
            showAlert('æª”æ¡ˆè®€å–æˆåŠŸï¼Œå…§å®¹å·²å¡«å…¥æ–‡å­—æ¡†ã€‚');
        };
        reader.onerror = () => showAlert('è®€å–æª”æ¡ˆå¤±æ•—ï¼', 'âŒ éŒ¯èª¤');
        reader.readAsText(file);
    });

    async function handleRunAnalysis() {
        const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
        const sourceText = document.getElementById('analysisSourceText').value.trim();
        const runBtn = document.getElementById('analysisRunBtn');

        if (!sourceText) {
            showAlert('è«‹å…ˆåœ¨æ–‡å­—æ¡†è²¼ä¸Šå…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆã€‚', 'âš ï¸ è­¦å‘Š');
            return;
        }

        runBtn.disabled = true;
        runBtn.innerHTML = `ğŸ§  AI åˆ†æä¸­... <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

        let prompt;
        if (analysisType === 'words') {
            prompt = `ä½ æ˜¯ä¸€ä½é‡å°ç¹é«”ä¸­æ–‡çš„èªè¨€åˆ†æå°ˆå®¶ã€‚è«‹åˆ†æä»¥ä¸‹å°å­¸è€å¸«çš„å‚™èª²è³‡æ–™ï¼Œä½ çš„ä»»å‹™æœ‰å…©å€‹æ­¥é©Ÿï¼š
1. é¦–å…ˆï¼Œåœ¨æä¾›çš„å‚™èª²è³‡æ–™ä¸­å®šä½åˆ°ã€Œèªè©è§£é‡‹ã€æˆ–é¡ä¼¼çš„æ¨™é¡Œ (ä¾‹å¦‚ï¼šèªè©èªªæ˜ã€æœ¬èª²èªè©)ã€‚
2. ç„¶å¾Œï¼Œ**åªå¾è©²æ¨™é¡Œä¹‹å¾Œçš„å…§å®¹ä¸­**ï¼ŒæŠ½å–å‡ºæ‰€æœ‰çš„æ ¸å¿ƒã€Œèªè©ã€ã€‚é€™äº›èªè©çš„æ ¼å¼é€šå¸¸æ˜¯ã€Œç·¨è™Ÿ. èªè©ï¼šè§£é‡‹...ã€ã€‚
**è¼¸å‡ºè¦æ±‚ï¼š**
è«‹åªåˆ—å‡ºæŠ½å‡ºçš„ã€Œèªè©ã€æœ¬èº«ï¼Œæ¯è¡Œä¸€å€‹ã€‚**çµ•å°ä¸è¦**åŒ…å«ä»»ä½•ç·¨è™Ÿã€è§£é‡‹ã€æ¨™é¡Œæˆ–èªªæ˜æ€§æ–‡å­— (ä¾‹å¦‚ "ä»¥ä¸‹æ˜¯..." é€™æ¨£çš„å¥å­)ã€‚
ã€å‚™èª²è³‡æ–™å¦‚ä¸‹ã€‘
${sourceText}`;
        } else { // patterns
            prompt = `ä½ æ˜¯ä¸€ä½å°ˆç²¾æ–¼ç¹é«”ä¸­æ–‡çš„èªè¨€çµæ§‹åˆ†æå°ˆå®¶ï¼Œç‰¹åˆ¥æ“…é•·å°å­¸å¥å‹æ•™å­¸ã€‚ä½ çš„ä»»å‹™æ˜¯è¾¨è­˜ä¸¦æŠ½å–å‡ºã€ŒçŸ­èªç·´ç¿’ã€ã€ã€Œå¥å‹ç·´ç¿’ã€ã€ã€Œé€ å¥ç·´ç¿’ã€ä¸‰ç¨®å…§å®¹ã€‚
**1. çŸ­èªç·´ç¿’åˆ†æ**
- **è¦å‰‡ï¼š** ç•¶æ‰¾åˆ°ã€ŒçŸ­èªç·´ç¿’ã€å€å¡Šæ™‚ï¼Œæ‰¾å‡ºä»¥ã€Œâ—ã€é–‹é ­çš„**èª²æ–‡ä¾‹å¥**ï¼Œå’Œä»¥ç·¨è™Ÿ (å¦‚ (1)ã€(2)) é–‹é ­çš„**ç¯„æœ¬å¥**ã€‚æ¯”è¼ƒå…©è€…æ‰¾å‡ºå¯æ›¿æ›çš„è©ï¼Œä¸¦åªè¼¸å‡º**èª²æ–‡ä¾‹å¥**ï¼Œå°‡å¯æ›¿æ›éƒ¨åˆ†ç”¨å…¨å½¢æ‹¬è™Ÿã€Œï¼ˆï¼‰ã€åŒ…èµ·ä¾†ã€‚
- **ç¯„ä¾‹è¼¸å‡º (å¿…é ˆæ˜¯æ­¤æ ¼å¼)ï¼š** ï¼ˆé›»å½±ï¼‰ä¸­ï¼ˆç„¡æ‰€ä¸èƒ½ï¼‰çš„ï¼ˆè¶…ç´šï¼‰ï¼ˆè‹±é›„ï¼‰
**2. å¥å‹ç·´ç¿’åˆ†æ**
- **è¦å‰‡ï¼š** å¦‚æœæ‰¾åˆ°å¥å‹ç·´ç¿’ï¼ŒæŠ½å–å‡ºæ ¸å¿ƒå¥æ§‹ï¼Œç”¨ ... ä»£è¡¨å¯è®Šå‹•çš„éƒ¨åˆ†ã€‚
- **ç¯„ä¾‹è¼¸å‡º (å¿…é ˆæ˜¯æ­¤æ ¼å¼)ï¼š** ...é›–é...ï¼Œå»æ²’æœ‰...
**3. é€ å¥ç·´ç¿’åˆ†æ**
- **è¦å‰‡ï¼š** ç•¶æ‰¾åˆ°ã€Œé€ å¥ç·´ç¿’ã€å€å¡Šæ™‚ï¼Œæ‰¾å‡ºä»¥æ•¸å­—å’Œé»é–‹é ­çš„**ç›®æ¨™èªè©** (å¦‚ã€Œ1.åˆ†äº«ã€)ã€‚æ¥è‘—ç¢ºèªä¸‹æ–¹çš„ç¯„ä¾‹å¥ (å¦‚ã€Œ(1)...ã€) ä¸­**ç¢ºå¯¦åŒ…å«**è©²ç›®æ¨™èªè©ã€‚å¦‚æœç¢ºèªåŒ…å«ï¼Œå°±åªè¼¸å‡ºè©²**ç›®æ¨™èªè©**æœ¬èº«ã€‚
- **ç¯„ä¾‹è¼¸å‡º (å¿…é ˆæ˜¯æ­¤æ ¼å¼)ï¼š** åˆ†äº«
**ç¸½è¼¸å‡ºè¦æ±‚ï¼š**
è«‹å°‡æ‰€æœ‰åˆ†æçµæœæ¢åˆ—å‡ºä¾†ï¼Œæ¯è¡Œä¸€ç­†è³‡æ–™ã€‚**çµ•å°ä¸è¦**åŒ…å«ä»»ä½•æ¨™é¡Œã€ç·¨è™Ÿã€èªªæ˜æˆ–ç©ºè¡Œ (ä¾‹å¦‚ "ä»¥ä¸‹æ˜¯..." é€™æ¨£çš„å¥å­)ã€‚
ã€å‚™èª²è³‡æ–™å¦‚ä¸‹ã€‘
${sourceText}`;
        }
        
        try {
            const resultText = await callGeminiApi(prompt);
            const resultTextArea = document.getElementById('analysisResultText');
            resultTextArea.value = resultText.trim();
            document.getElementById('analysisImportBtn').disabled = resultText.trim() === '';
            saveAnalysisDataToLocal();
            showAlert('AI åˆ†æå®Œæˆï¼');
        } catch (error)
        {
            showAlert(`åˆ†æå¤±æ•—ï¼š${error.message}`, 'âŒ éŒ¯èª¤');
        } finally {
            runBtn.disabled = false;
            runBtn.textContent = 'ğŸ¤– é‡æ–°åˆ†æ';
        }
    }

    function copyAnalysisResults() {
        const resultText = document.getElementById('analysisResultText').value;
        if (resultText.trim() === '') {
            showAlert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹ã€‚', 'ğŸ¤” æç¤º');
            return;
        }
        
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = resultText;
        tempTextArea.style.position = 'fixed';
        tempTextArea.style.left = '-9999px';
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        tempTextArea.setSelectionRange(0, 99999);

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showAlert('å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } else {
                showAlert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤æ“ä½œã€‚', 'âŒ éŒ¯èª¤');
            }
        } catch (err) {
            showAlert('è¤‡è£½æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'âŒ éŒ¯èª¤');
        }

        document.body.removeChild(tempTextArea);
    }

    function handleImportAnalysis() {
        const results = document.getElementById('analysisResultText').value.trim().split('\n').filter(Boolean);
        if (results.length === 0) {
            showAlert('åˆ†æçµæœç‚ºç©ºï¼Œç„¡æ³•å°å…¥ã€‚', 'âš ï¸ è­¦å‘Š');
            return;
        }

        const targetCardId = document.getElementById('analysisImportSelect').value;
        const card = cardsData.find(c => c.id === targetCardId);
        
        showConfirm(`ç¢ºå®šè¦å°‡ ${results.length} ç­†çµæœå°å…¥åˆ°ã€Œ${card.title}ã€å—ï¼Ÿé€™å°‡æœƒ<strong class="text-red-600">æ¸…ç©º</strong>è©²é¡åˆ¥çš„ç¾æœ‰å…§å®¹ã€‚`, () => {
            card.content = results;
            saveDataToLocal();
            renderEditSection(); 
            closeAnalysisModal();
            showAlert(`å·²æˆåŠŸå°å…¥ ${results.length} ç­†è³‡æ–™åˆ°ã€Œ${card.title}ã€ï¼`);
        });
    }
    
    // --- Gemini API å‘¼å« (v2.5.2 ä¿®æ­£) ---
    /**
     * @param {string} prompt - å‚³é€çµ¦ AI çš„æç¤º
     * @param {boolean} requestJson - æ˜¯å¦è¦æ±‚ AI å›å‚³ JSON æ ¼å¼ (é è¨­ç‚º false)
     */
    async function callGeminiApi(prompt, requestJson = false) {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        
        if (!apiKey) {
            throw new Error("å°šæœªè¨­å®š Google AI API é‡‘é‘°ã€‚è«‹è¿”å›ã€Œè¨­å®šã€é é¢ï¼Œåœ¨æœ€ä¸Šæ–¹è¼¸å…¥æ‚¨çš„é‡‘é‘°ã€‚");
        }
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = { 
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: requestJson ? "application/json" : "text/plain",
            }
        };
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
        }
        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
            return candidate.content.parts[0].text;
        } else {
            if (candidate && candidate.finishReason && candidate.finishReason !== "STOP") {
                 throw new Error(`API å›æ‡‰å›  ${candidate.finishReason} è€Œä¸­æ–·ï¼Œè«‹æª¢æŸ¥ Prompt æˆ–ç¨å¾Œå†è©¦ã€‚`);
            }
            throw new Error("å¾ API æ”¶åˆ°çš„å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
        }
    }

    // --- å¯æ‹–æ›³çš„ Modal ---
    function makeModalDraggable(modalId, headerSelector) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const modalContent = modal.querySelector('.modal-content');
        const header = modal.querySelector(headerSelector);
        
        if (!modalContent || !header) return;

        let isDragging = false;
        let initialMouseX, initialMouseY;
        let currentPosX = 0, currentPosY = 0;

        const onMouseMove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            
            const dx = e.clientX - initialMouseX;
            const dy = e.clientY - initialMouseY;
            
            const newPosX = currentPosX + dx;
            const newPosY = currentPosY + dy;
            
            modalContent.style.transform = `translate(${newPosX}px, ${newPosY}px) scale(1)`;
        };

        const onMouseUp = (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            const dx = e.clientX - initialMouseX;
            const dy = e.clientY - initialMouseY;
            
            currentPosX += dx;
            currentPosY += dy;
            
            modalContent.dataset.posX = currentPosX;
            modalContent.dataset.posY = currentPosY;
            
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };

        header.addEventListener('mousedown', (e) => {
            if (e.target.tagName === 'BUTTON') return;
            
            e.preventDefault();
            isDragging = true;
            
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;
            
            currentPosX = parseFloat(modalContent.dataset.posX) || 0;
            currentPosY = parseFloat(modalContent.dataset.posY) || 0;

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }


    // --- å¥å­é‡çµ„éŠæˆ² (v2.5.1 æ›´æ–°) ---

    function escapeRegExp(string) {
        return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    function getPosClass(posTag) {
        if (!posTag) return 'pos-default';
        const tag = posTag.toLowerCase();
        
        if (tag.includes('åè©')) return 'pos-n';
        if (tag.includes('å‹•è©')) return 'pos-v';
        if (tag.includes('å½¢å®¹è©')) return 'pos-adj';
        if (tag.includes('å‰¯è©')) return 'pos-adv';
        if (tag.includes('ä»‹è©') || tag.includes('ä»‹ç³»è©')) return 'pos-prep';
        
        // --- v2.5.4: ä¿®æ­£æ­¤è™•çš„ SyntaxError ---
        if (tag.includes('é€£è©') || tag.includes('é€£æ¥è©')) return 'pos-conj';
        
        if (tag.includes('åŠ©è©') || tag.includes('èªåŠ©è©')) return 'pos-part'; 
        if (tag.includes('ä»£åè©') || tag.includes('ä»£è©')) return 'pos-pron';
        if (tag.includes('ç‹€è²è©') || tag.includes('æ“¬è²è©')) return 'pos-ono'; 
        if (tag.includes('æ¨™é»') || tag.includes('ç¬¦è™Ÿ')) return 'pos-punc';
        
        if (['äº†', 'çš„', 'è‘—', 'å€‹', 'åœ°', 'å¾—'].includes(tag)) return 'pos-part';
        if (['ä¸Š', 'ä¸‹', 'è£¡', 'å¤–', 'å‰', 'å¾Œ'].includes(tag)) return 'pos-prep';
        
        return 'pos-default';
    }


    /**
     * v2.5.1: æ­¤å‡½å¼ 'fallback_splitSentence' åƒ…ä½œç‚º AI å›å‚³è³‡æ–™å¤±æ•—æ™‚çš„ã€Œå‚™ç”¨æ–¹æ¡ˆã€ã€‚
     */
    function fallback_splitSentence(sentence, pattern) {
        console.warn("æ­£åœ¨å•Ÿç”¨ Fallback å¥å­æ‹†åˆ†é‚è¼¯...");
        let blocks = [];
        const basePunctuation = 'ï¼Œã€‚ï¼Ÿï¼ã€ï¼šï¼›';
        const bracketPunctuation = 'ã€Œã€ã€ã€';
        const punctuationRegex = new RegExp(`([${escapeRegExp(basePunctuation + bracketPunctuation)}])`, 'g');
        const finalPunctuationRegex = new RegExp(`[${escapeRegExp('ã€‚ï¼Ÿï¼')}]$`);
        
        if (/[()ï¼ˆï¼‰]/.test(sentence)) {
            blocks = sentence.split(/[()ï¼ˆï¼‰]/g).filter(s => s.trim() !== '');
        } 
        else if (pattern && pattern.includes('...')) {
            let keywords = pattern.split('...').filter(s => s.trim() !== '');
            let allSeparators = [...keywords, ...basePunctuation.split('')];
            let uniqueSeparators = [...new Set(allSeparators)];
            let regex = new RegExp(`(${uniqueSeparators.map(escapeRegExp).join('|')})`, 'g');
            blocks = sentence.split(regex).filter(s => s.trim() !== '');
            
        } 
        else {
            blocks = sentence.split(punctuationRegex).filter(s => s.trim() !== '');
        }

        let finalBlocks = [];
        for (let block of blocks) {
            if (!punctuationRegex.test(block) && finalPunctuationRegex.test(block)) {
                finalBlocks.push(block.slice(0, -1));
                finalBlocks.push(block.slice(-1));
            } else {
                finalBlocks.push(block);
            }
        }
        
        return finalBlocks.filter(s => s.trim() !== '');
    }

    /**
     * v2.5.1 æ›´æ–°: å¢åŠ  blocksJSON, posTagsJSON åƒæ•¸
     */
    function openScrambleGame(sentence, pattern, blocksJSON, posTagsJSON) {
        currentScrambleSentence = sentence;
        currentScramblePattern = pattern;
        currentScrambleBlocksJSON = blocksJSON || '[]'; 
        currentScramblePosTagsJSON = posTagsJSON || '[]';
        
        let correctScrambleBlocks = [];
        let posTags = [];
        
        try {
            correctScrambleBlocks = JSON.parse(blocksJSON);
        } catch(e) { console.error('ç„¡æ³•è§£æ Blocks JSON:', e); }
        
        try {
            posTags = JSON.parse(posTagsJSON);
        } catch(e) { console.error('ç„¡æ³•è§£æ POS Tags JSON:', e); }

        if (!correctScrambleBlocks || correctScrambleBlocks.length === 0 || correctScrambleBlocks.length !== posTags.length) {
            console.warn("AI æä¾›çš„ blocks å’Œ pos_tags ä¸åŒ¹é…æˆ–ç‚ºç©ºï¼Œå•Ÿç”¨ fallback æ‹†åˆ†é‚è¼¯ã€‚");
            correctScrambleBlocks = fallback_splitSentence(sentence, pattern);
            posTags = []; 
        }
        
        let blockObjects = correctScrambleBlocks.map((text, index) => ({
            text: text,
            pos: (posTags && posTags[index]) ? getPosClass(posTags[index]) : 'pos-default'
        }));
        
        let shuffledBlockObjects = [...blockObjects].sort(() => Math.random() - 0.5);

        const sourceContainer = document.getElementById('scrambleSource');
        const targetContainer = document.getElementById('scrambleTarget');
        const hintBox = document.getElementById('scrambleHint');

        sourceContainer.innerHTML = '';
        targetContainer.innerHTML = '';
        targetContainer.classList.remove('is-correct', 'is-incorrect');
        hintBox.classList.add('hidden');
        hintBox.textContent = '';

        shuffledBlockObjects.forEach((blockObj, index) => {
            const block = document.createElement('div');
            block.id = `scramble-block-${index}`;
            block.className = `scramble-block ${blockObj.pos}`;
            block.draggable = true;
            
            const textSpan = document.createElement('span');
            textSpan.textContent = blockObj.text;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'scramble-remove-btn';
            removeBtn.innerHTML = '&times;'; 
            removeBtn.title = 'ç§»å›èªæ–™åº«';
            removeBtn.onclick = (e) => {
                e.stopPropagation(); 
                handleRemoveBlock(block); 
            };
            
            block.appendChild(textSpan);
            block.appendChild(removeBtn);
            
            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
            
            sourceContainer.appendChild(block);
        });

        showModal(scrambleModal);
    }
    
    function handleRemoveBlock(blockElement) {
        const sourceContainer = document.getElementById('scrambleSource');
        sourceContainer.appendChild(blockElement);
    }

    function closeScrambleGame() {
        hideModal(scrambleModal);
    }
    
    function resetScrambleGame() {
        openScrambleGame(currentScrambleSentence, currentScramblePattern, currentScrambleBlocksJSON, currentScramblePosTagsJSON);
    }
    
    function checkScrambleAnswer() {
        const targetContainer = document.getElementById('scrambleTarget');
        const answerBlocks = Array.from(targetContainer.querySelectorAll('.scramble-block span'));
        const userAnswer = answerBlocks.map(span => span.textContent).join('');
        
        targetContainer.classList.remove('is-correct', 'is-incorrect');

        const targetSentence = currentScrambleSentence.replace(/[()ï¼ˆï¼‰]/g, '');

        if (userAnswer === targetSentence) {
            targetContainer.classList.add('is-correct');
            showAlert('å¤ªæ£’äº†ï¼å¥å­å®Œå…¨æ­£ç¢ºï¼', 'âœ”ï¸ ç­”å°äº†');
        } else {
            targetContainer.classList.add('is-incorrect');
            showAlert('å·®ä¸€é»é»ï¼Œå†è©¦è©¦çœ‹ï¼', 'âŒ å†åŠ æ²¹');
        }
    }
    
    function toggleScrambleHint() {
        const hintBox = document.getElementById('scrambleHint');
        if (hintBox.classList.contains('hidden')) {
            hintBox.textContent = `ğŸ’¡ æç¤ºï¼š${currentScrambleSentence}`;
            hintBox.classList.remove('hidden');
        } else {
            hintBox.classList.add('hidden');
        }
    }

    // --- æ‹–æ›³ (Drag & Drop) é‚è¼¯ ---
    
    let draggingElement = null;
    
    function handleDragStart(e) {
        if (e.target.classList.contains('scramble-remove-btn')) {
            e.preventDefault();
            return;
        }
        draggingElement = e.target;
        setTimeout(() => e.target.classList.add('dragging'), 0);
        e.dataTransfer.setData('text/plain', e.target.id);
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        if (!draggingElement) return;
        draggingElement.classList.remove('dragging');
        draggingElement = null;
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        if (!draggingElement) return;
        
        const container = e.currentTarget;
        container.classList.add('drag-over'); 
        
        const afterElement = getDragAfterElement(container, e.clientX, e.clientY);
        
        if (afterElement == null) {
            container.appendChild(draggingElement);
        } else {
            container.insertBefore(draggingElement, afterElement);
        }
    }

    function handleDragEnter(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
    }

    function getDragAfterElement(container, x, y) {
        const draggableElements = [...container.querySelectorAll('.scramble-block:not(.dragging)')];

        const result = draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const boxCenterY = box.top + box.height / 2;
            const boxCenterX = box.left + box.width / 2;

            const isCursorBefore = (y < boxCenterY) || 
                                   (y >= box.top && y <= box.bottom && x < boxCenterX);

            if (isCursorBefore) {
                const distance = Math.sqrt(Math.pow(x - box.left, 2) + Math.pow(y - box.top, 2));

                if (distance < closest.distance) {
                    return { distance: distance, element: child };
                }
            }
            
            return closest;
            
        }, { distance: Number.POSITIVE_INFINITY });

        return result.element;
    }
    
    // --- é é¢åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        // API é‡‘é‘°
        const apiKeyInput = document.getElementById('apiKeyInput');
        const savedApiKey = localStorage.getItem('googleAiApiKey_v2_0');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }
        
        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem('googleAiApiKey_v2_0', apiKeyInput.value);
        });
        
        loadDataFromLocal();
        renderEditSection();
        
        // èªéŸ³
        try {
            speechSynth = window.speechSynthesis;
            if (speechSynth.getVoices().length === 0) {
                speechSynth.onvoiceschanged = () => {};
            }
        } catch (e) { console.error('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API:', e); }
        
        // ç¶å®šéŠæˆ²å€çš„æ‹–æ›³äº‹ä»¶
        const sourceContainer = document.getElementById('scrambleSource');
        const targetContainer = document.getElementById('scrambleTarget');

        sourceContainer.addEventListener('dragover', handleDragOver);
        sourceContainer.addEventListener('dragenter', handleDragEnter);
        sourceContainer.addEventListener('dragleave', handleDragLeave);
        sourceContainer.addEventListener('drop', handleDrop);

        targetContainer.addEventListener('dragover', handleDragOver);
        targetContainer.addEventListener('dragenter', handleDragEnter);
        targetContainer.addEventListener('dragleave', handleDragLeave);
        targetContainer.addEventListener('drop', handleDrop);
        
        // å•Ÿå‹• Modal æ‹–æ›³åŠŸèƒ½
        makeModalDraggable('scrambleModal', '.modal-content h3');
    });
</script>
</body>
</html>